<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Scanner Pro v3.1 - Fixed Multi-Mode Scanner</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; opacity: 1; transition: opacity 1s ease-out;
        }
        .loading-screen.fade-out { opacity: 0; }
        
        .welcome-content { text-align: center; animation: welcomeSlide 2s ease-out; }
        .welcome-title {
            font-size: 3.5em; color: #4a90e2; margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
        }
        .welcome-subtitle { font-size: 1.3em; color: #888; margin-bottom: 30px; }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid #4a90e2; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        
        @keyframes welcomeSlide {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .app-container { 
            opacity: 0; transition: opacity 1s ease-in; padding: 20px;
            transform: translateY(20px);
        }
        .app-container.loaded { opacity: 1; transform: translateY(0); }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #4a90e2; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #888; font-size: 1.1em; }
        
        .usage-tracker {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 12px;
            padding: 15px; margin-bottom: 20px;
        }
        .usage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .usage-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .usage-bar { background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden; }
        .usage-fill { height: 100%; background: #4a90e2; transition: width 0.3s ease; }
        
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .section {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; position: relative;
        }
        .section h3 { color: #4a90e2; margin-bottom: 15px; font-size: 1.3em; }
        
        /* MULTI-MODE SCANNER SECTION */
        .scanner-modes {
            display: flex; gap: 10px; margin-bottom: 15px;
        }
        .mode-btn {
            flex: 1; padding: 12px; border: 2px solid #333; background: #2a2a2a;
            border-radius: 8px; cursor: pointer; text-align: center;
            transition: all 0.3s ease; font-size: 14px;
        }
        .mode-btn.active { border-color: #4a90e2; background: rgba(74, 144, 226, 0.1); }
        .mode-btn:hover { border-color: #4a90e2; }
        .mode-icon { font-size: 20px; display: block; margin-bottom: 5px; }
        .mode-name { font-weight: bold; color: #4a90e2; margin-bottom: 3px; }
        .mode-desc { font-size: 11px; color: #888; }
        
        .video-container {
            position: relative; background: #000; border-radius: 8px; overflow: hidden;
            aspect-ratio: 16/9; margin-bottom: 15px;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .camera-status {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 8px;
        }
        
        .controls { display: flex; gap: 10px; }
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 14px; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .btn-primary { background: #4a90e2; color: white; flex: 1; }
        .btn-primary:hover { background: #357abd; transform: translateY(-2px); }
        .btn-secondary { background: #28a745; color: white; padding: 12px 16px; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        
        /* SCAN RESULTS */
        .result-card {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 8px;
            padding: 20px; text-align: center; position: relative;
            animation: resultSlideIn 0.6s ease-out;
        }
        .result-card h4 { color: #4a90e2; font-size: 1.4em; margin-bottom: 10px; }
        .confidence { color: #888; margin-bottom: 15px; }
        .placeholder {
            background: #2a2a2a; border-radius: 8px; padding: 40px;
            text-align: center; color: #888;
        }
        
        @keyframes resultSlideIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* EDITION PICKER */
        .edition-picker {
            background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107;
            border-radius: 8px; padding: 15px; margin: 15px 0;
        }
        .edition-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px; margin-top: 10px;
        }
        .edition-option {
            background: #2a2a2a; border: 1px solid #444; border-radius: 6px;
            padding: 8px; text-align: center; cursor: pointer; transition: all 0.3s ease;
            font-size: 12px;
        }
        .edition-option:hover { border-color: #ffc107; background: rgba(255, 193, 7, 0.1); }
        .edition-code { font-weight: bold; color: #ffc107; }
        .edition-name { color: #ccc; font-size: 10px; }

        /* SCAN FEEDBACK */
        .scan-feedback-bar {
            background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107;
            border-radius: 8px; padding: 12px; margin: 15px 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .feedback-actions {
            display: flex; gap: 8px;
        }
        .retry-btn {
            background: #ffc107; color: #000; padding: 6px 12px;
            border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
            font-weight: bold;
        }
        .correct-btn {
            background: #28a745; color: white; padding: 6px 12px;
            border: none; border-radius: 4px; cursor: pointer; font-size: 12px;
            font-weight: bold;
        }

        /* COLLECTION SECTION - SIMPLIFIED */
        .collection-section {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px;
        }
        .collection-tabs {
            display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px;
            scrollbar-width: thin; scrollbar-color: #4a90e2 #1a1a1a;
        }
        .collection-tab {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 8px;
            padding: 10px 15px; cursor: pointer; white-space: nowrap;
            transition: all 0.3s ease; min-width: fit-content; text-align: center;
            font-size: 13px; display: flex; align-items: center; gap: 5px;
        }
        .collection-tab.active { background: #4a90e2; color: white; }
        .collection-tab:hover { background: #3a3a3a; }
        
        .collection-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-item {
            background: #2a2a2a; border-radius: 6px; padding: 12px; text-align: center;
        }
        .stat-number { font-size: 24px; font-weight: bold; color: #4a90e2; }
        .stat-label { font-size: 12px; color: #888; }
        
        .collection-content {
            background: #1a1a1a; border-radius: 8px; padding: 15px; min-height: 200px;
        }
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }
        .collection-card {
            background: #2a2a2a; border-radius: 12px; border: 1px solid #333; 
            padding: 15px; transition: all 0.3s ease; position: relative;
            overflow: hidden;
        }
        .collection-card:hover { 
            border-color: #4a90e2; transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.2);
        }
        .card-name { 
            font-weight: bold; color: #4a90e2; margin-bottom: 8px; font-size: 16px;
        }
        .card-details { 
            font-size: 12px; color: #888; margin-bottom: 10px;
        }
        .card-price {
            background: #4a90e2; color: white; padding: 4px 8px; border-radius: 6px;
            font-size: 12px; font-weight: bold; display: inline-block;
        }
        
        /* UTILITIES */
        .toast {
            position: fixed; top: 20px; right: 20px; z-index: 10001;
            background: #28a745; color: white; padding: 12px 20px;
            border-radius: 8px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
        }
        .toast.error { background: #dc3545; }
        .toast.warning { background: #ffc107; color: #000; }
        
        @keyframes slideIn {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 1024px) { 
            .main-grid { grid-template-columns: 1fr; }
            .scanner-modes { flex-direction: column; }
            .mode-btn { display: flex; align-items: center; gap: 10px; text-align: left; }
            .mode-icon { margin-bottom: 0; }
        }
        @media (max-width: 768px) { 
            .welcome-title { font-size: 2.5em; }
            .collection-tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="loadingScreen" class="loading-screen">
        <div class="welcome-content">
            <div class="welcome-title">🃏 MTG Scanner Pro</div>
            <div class="welcome-subtitle">Multi-Mode AI Recognition • Real-Time Pricing • Smart Collections</div>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Version 3.1 - Fixed & Streamlined</div>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app-container">
        <div class="container">
            <div class="header">
                <h1>🃏 MTG Scanner Pro v3.1</h1>
                <p>Multi-Mode Recognition • Edition Detection • Smart Collections</p>
            </div>

            <div class="usage-tracker">
                <div class="usage-header">
                    <span style="color: #4a90e2; font-weight: bold;">
                        📊 <span id="usagePeriodLabel">Daily</span> Usage (<span id="userTierDisplay">Free</span>)
                    </span>
                    <button id="upgradeBtn" class="btn" style="background: #4a90e2; color: white; padding: 6px 12px; font-size: 12px; border-radius: 6px;">
                        💎 Upgrade - Starting $4.99
                    </button>
                </div>
                <div class="usage-stats">
                    <span style="font-weight: bold;"><span id="usageCount">0</span> / <span id="usageLimit">20</span> scans</span>
                    <span style="color: #888; font-size: 12px;"><span id="remainingCount">20</span> remaining</span>
                </div>
                <div class="usage-bar">
                    <div id="usageBar" class="usage-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="main-grid">
                <!-- MULTI-MODE SCANNER -->
                <div class="section">
                    <h3>📷 Multi-Mode Scanner</h3>
                    
                    <div class="scanner-modes">
                        <div class="mode-btn active" data-mode="fast">
                            <span class="mode-icon">⚡</span>
                            <div>
                                <div class="mode-name">Fast</div>
                                <div class="mode-desc">Quick name scan</div>
                            </div>
                        </div>
                        <div class="mode-btn" data-mode="accurate">
                            <span class="mode-icon">🎯</span>
                            <div>
                                <div class="mode-name">Accurate</div>
                                <div class="mode-desc">Full edition data</div>
                            </div>
                        </div>
                        <div class="mode-btn" data-mode="manual">
                            <span class="mode-icon">✏️</span>
                            <div>
                                <div class="mode-name">Manual</div>
                                <div class="mode-desc">Text search</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <div id="cameraStatus" class="camera-status">📷 Initializing camera...</div>
                    </div>
                    
                    <div class="controls">
                        <button id="scanBtn" class="btn btn-primary" disabled>🧠 AI Scan Card</button>
                        <button id="autoBtn" class="btn btn-secondary">▶️ Auto</button>
                    </div>

                    <!-- Manual Mode Input (hidden by default) -->
                    <div id="manualInput" style="display: none; margin-top: 15px;">
                        <input type="text" id="manualSearch" placeholder="Enter card name..." 
                               style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #4a90e2; 
                                      border-radius: 6px; color: white; font-size: 14px;">
                        <button onclick="manualSearch()" class="btn" style="background: #4a90e2; color: white; width: 100%; margin-top: 10px;">
                            🔍 Search Card
                        </button>
                    </div>
                </div>

                <!-- SCAN RESULTS -->
                <div class="section">
                    <h3>🎯 Scan Results</h3>
                    <div id="results">
                        <div class="placeholder">📷 Point camera at MTG card and click scan</div>
                    </div>
                </div>
            </div>

            <!-- COLLECTION SECTION -->
            <div class="collection-section">
                <h3 style="color: #4a90e2; margin-bottom: 20px;">📚 Smart Collections</h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="collection-tabs" style="flex: 1;">
                        <div class="collection-tab active" data-collection="main">📂 Main</div>
                        <div class="collection-tab" data-collection="commander">👑 Commander</div>
                        <div class="collection-tab" data-collection="modern">⚡ Modern</div>
                        <div class="collection-tab" data-collection="standard">🎯 Standard</div>
                        <div class="collection-tab" data-collection="premium">💎 Premium</div>
                        <div class="collection-tab" data-collection="trade">🔄 Trade</div>
                        <div class="collection-tab" data-collection="wishlist">⭐ Wishlist</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-left: 20px;">
                        <button onclick="exportCollection()" class="btn" style="background: #28a745; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                            📤 Export
                        </button>
                        <button onclick="aiSortCollection()" class="btn" style="background: #6f42c1; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                            🤖 Sort
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="collectionSearch" placeholder="🔍 Search cards..." 
                           style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
                                  border-radius: 6px; color: white; font-size: 14px;"
                           onkeyup="filterCollection()">
                    <button onclick="batchOperations()" class="btn" style="background: #fd7e14; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                        ⚡ Batch
                    </button>
                </div>
                
                <div class="collection-content">
                    <div class="collection-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalCards">0</div>
                            <div class="stat-label">Total Cards</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="uniqueCards">0</div>
                            <div class="stat-label">Unique Cards</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalValue">$0.00</div>
                            <div class="stat-label">Collection Value</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="scanAccuracy">--</div>
                            <div class="stat-label">Avg Accuracy</div>
                        </div>
                    </div>
                    
                    <div id="collectionCards" class="card-grid">
                        <div style="text-align: center; color: #888; padding: 40px;">
                            No cards in this collection yet. Start scanning to build your collection!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🚀 MTG SCANNER PRO v3.1 - FIXED & STREAMLINED
        console.log("🚀 MTG Scanner Pro v3.1 Loading (Fixed & Streamlined)...");

        // ENHANCED MTG SERVICE - FIXED API CALLS
        class FixedMTGService {
            constructor() {
                this.apiKey = 'AIzaSyBtqyUy1X3BdNtUAW88QZWbtqI39MbUDdk';
                this.geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
                this.scryfallUrl = 'https://api.scryfall.com';
                this.lastApiCall = 0;
                this.minInterval = 2000;
                this.currentMode = 'fast';
            }

            setMode(mode) {
                this.currentMode = mode;
                console.log(`🎯 Scan mode set to: ${mode}`);
            }

            async scanCard(video) {
                try {
                    // Rate limiting
                    const now = Date.now();
                    if (now - this.lastApiCall < this.minInterval) {
                        await new Promise(r => setTimeout(r, this.minInterval - (now - this.lastApiCall)));
                    }
                    this.lastApiCall = Date.now();

                    const imageData = this.captureFrame(video);
                    const aiResult = await this.callGemini(imageData);
                    
                    if (aiResult.hasCard) {
                        aiResult.cardData = await this.getCardData(aiResult);
                        console.log(`✅ ${this.currentMode} scan:`, aiResult.name, `(${aiResult.confidence}%)`);
                    }
                    
                    return aiResult;
                } catch (error) {
                    console.error("🚨 Scan error:", error);
                    return {
                        hasCard: false,
                        message: "Scanner error - please try again",
                        error: true
                    };
                }
            }

            async getCardData(aiResult) {
                try {
                    console.log(`🔍 Getting card data for ${this.currentMode} scan:`, aiResult);
                    
                    if (this.currentMode === 'accurate' && aiResult.setCode && aiResult.collectorNumber) {
                        // Try exact set/collector number match first
                        const exactUrl = `${this.scryfallUrl}/cards/${aiResult.setCode.toLowerCase()}/${aiResult.collectorNumber}`;
                        console.log(`🎯 Exact match URL: ${exactUrl}`);
                        
                        const exactResponse = await fetch(exactUrl);
                        if (exactResponse.ok) {
                            const data = await exactResponse.json();
                            console.log(`✅ EXACT MATCH FOUND:`, data.name);
                            return this.formatCardData(data);
                        }
                        console.warn(`⚠️ Exact match failed, falling back to fuzzy search`);
                    }
                    
                    // Fallback to fuzzy search with just the card name
                    const cardNameOnly = aiResult.name.trim();
                    const fuzzyUrl = `${this.scryfallUrl}/cards/named?fuzzy=${encodeURIComponent(cardNameOnly)}`;
                    console.log(`🔍 Fuzzy search: ${fuzzyUrl}`);
                    
                    const fuzzyResponse = await fetch(fuzzyUrl);
                    if (fuzzyResponse.ok) {
                        const data = await fuzzyResponse.json();
                        console.log(`✅ Fuzzy match found:`, data.name);
                        
                        // If we got a different edition, offer alternatives
                        if (this.currentMode === 'accurate' && aiResult.setCode && 
                            data.set.toUpperCase() !== aiResult.setCode.toUpperCase()) {
                            console.log(`⚠️ Edition mismatch: Expected ${aiResult.setCode}, got ${data.set.toUpperCase()}`);
                            await this.findAlternativeEditions(cardNameOnly, aiResult.setCode);
                        }
                        
                        return this.formatCardData(data);
                    }
                    
                    console.error(`❌ No matches found for: ${cardNameOnly}`);
                    return {
                        name: cardNameOnly,
                        price: 'Price unavailable',
                        set: 'Unknown',
                        scryfallError: true
                    };
                    
                } catch (error) {
                    console.error('❌ Card data fetch error:', error);
                    return {
                        name: aiResult.name,
                        price: 'Price unavailable',
                        set: 'Unknown',
                        scryfallError: true
                    };
                }
            }

            async findAlternativeEditions(cardName, expectedSet) {
                try {
                    const searchUrl = `${this.scryfallUrl}/cards/search?q=!"${cardName}"`;
                    const response = await fetch(searchUrl);
                    
                    if (response.ok) {
                        const data = await response.json();
                        const alternatives = data.data.slice(0, 6).map(card => ({
                            setCode: card.set.toUpperCase(),
                            setName: card.set_name,
                            price: card.prices?.usd || '—',
                            rarity: card.rarity,
                            image: card.image_uris?.small
                        }));
                        
                        this.showEditionPicker(cardName, alternatives, expectedSet);
                    }
                } catch (error) {
                    console.error('❌ Alternative editions fetch error:', error);
                }
            }

            showEditionPicker(cardName, alternatives, expectedSet) {
                const pickerHtml = `
                    <div class="edition-picker">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <span>⚠️ <strong>Edition Detected:</strong> Multiple versions found</span>
                            <button onclick="hideEditionPicker()" style="background: none; border: none; color: #888; cursor: pointer;">✕</button>
                        </div>
                        <div class="edition-grid">
                            ${alternatives.map(alt => `
                                <div class="edition-option" onclick="selectEdition('${cardName}', '${alt.setCode}')">
                                    <div class="edition-code">${alt.setCode}</div>
                                    <div class="edition-name">${alt.setName}</div>
                                    <div style="color: #4a90e2; font-weight: bold; margin-top: 5px;">$${alt.price}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                const resultsDiv = document.getElementById('results');
                const existingPicker = resultsDiv.querySelector('.edition-picker');
                if (existingPicker) existingPicker.remove();
                
                resultsDiv.insertAdjacentHTML('beforeend', pickerHtml);
            }

            formatCardData(data) {
                let price = 'Price unavailable';
                if (data.prices) {
                    price = data.prices.usd || 
                           data.prices.usd_foil || 
                           data.prices.eur || 
                           data.prices.tix || 
                           'Price not available';
                    
                    // Format price properly
                    if (price !== 'Price not available' && price !== 'Price unavailable') {
                        price = `$${parseFloat(price).toFixed(2)}`;
                    }
                }
                
                return {
                    name: data.name,
                    image: data.image_uris ? data.image_uris.normal : null,
                    price: price,
                    set: data.set_name,
                    setCode: data.set.toUpperCase(),
                    rarity: data.rarity,
                    scryfallId: data.id,
                    scryfallUri: data.scryfall_uri || data.uri,
                    cmc: data.cmc || 0,
                    colors: data.colors || [],
                    type_line: data.type_line || '',
                    collectorNumber: data.collector_number || '',
                    releaseDate: data.released_at || ''
                };
            }

            captureFrame(video) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                ctx.drawImage(video, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            }

            async callGemini(imageData) {
                let prompt;
                
                if (this.currentMode === 'fast') {
                    prompt = "Identify this Magic: The Gathering card. Respond with: CARD_NAME: [exact name] CONFIDENCE: [80-99]. If no MTG card visible, respond: NO_MTG_CARD";
                } else if (this.currentMode === 'accurate') {
                    prompt = "Analyze this MTG card for exact edition details. Respond with: CARD_NAME: [exact name] | SET_CODE: [3-letter code] | COLLECTOR_NUM: [number] | RARITY: [common/uncommon/rare/mythic] | CONFIDENCE: [80-99]. If no MTG card, respond: NO_MTG_CARD";
                }

                const body = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: imageData } }
                        ]
                    }]
                };

                const response = await fetch(this.geminiUrl + '?key=' + this.apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                console.log("🧠 Gemini response:", text);
                
                if (text.includes('NO_MTG_CARD')) {
                    return { hasCard: false, message: "No MTG card detected" };
                }

                return this.parseGeminiResponse(text);
            }

            parseGeminiResponse(text) {
                console.log("📝 Parsing Gemini response:", text);
                
                // Extract card name (everything before the first |, SET_CODE, or CONFIDENCE)
                const nameMatch = text.match(/CARD_NAME:\s*([^|\n]+?)(?:\s*\||SET_CODE|CONFIDENCE|$)/i);
                const confMatch = text.match(/CONFIDENCE:\s*(\d+)/i);
                
                if (!nameMatch) {
                    console.error("❌ Could not parse card name from:", text);
                    return { hasCard: false, message: "Could not parse response" };
                }
                
                const cardName = nameMatch[1].trim();
                const confidence = parseInt(confMatch?.[1] || '85');
                
                const result = {
                    hasCard: true,
                    name: cardName,
                    confidence: confidence,
                    source: `${this.currentMode}_mode_gemini`
                };
                
                // For accurate mode, extract additional details
                if (this.currentMode === 'accurate') {
                    const setMatch = text.match(/SET_CODE:\s*([A-Z0-9]{2,4})/i);
                    const collectorMatch = text.match(/COLLECTOR_NUM:\s*(\d+)/i);
                    const rarityMatch = text.match(/RARITY:\s*(common|uncommon|rare|mythic)/i);
                    
                    if (setMatch) result.setCode = setMatch[1].toUpperCase();
                    if (collectorMatch) result.collectorNumber = collectorMatch[1];
                    if (rarityMatch) result.rarity = rarityMatch[1].toLowerCase();
                }
                
                console.log("📝 Parsed result:", result);
                return result;
            }

            async manualSearch(cardName) {
                try {
                    const cleanName = cardName.trim();
                    if (!cleanName) return { hasCard: false, message: "Please enter a card name" };
                    
                    console.log(`🔍 Manual search: ${cleanName}`);
                    
                    const result = {
                        hasCard: true,
                        name: cleanName,
                        confidence: 100,
                        source: 'manual_search'
                    };
                    
                    result.cardData = await this.getCardData(result);
                    return result;
                    
                } catch (error) {
                    console.error("❌ Manual search error:", error);
                    return { hasCard: false, message: "Search failed - please try again" };
                }
            }
        }

        // GLOBAL VARIABLES
        let currentCard = null;
        let collections = { 
            main: [], commander: [], modern: [], standard: [], 
            premium: [], trade: [], wishlist: []
        };
        let activeCollection = 'main';
        let autoMode = false;
        let autoInterval = null;
        let userTier = localStorage.getItem('mtg_user_tier') || 'free';
        let userPlan = localStorage.getItem('mtg_plan_type') || 'free';
        let aiService = new FixedMTGService();
        
        // LOADING SEQUENCE
        function runLoadingSequence() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainApp = document.getElementById('mainApp');
                
                loadingScreen.classList.add('fade-out');
                mainApp.classList.add('loaded');
                
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1000);
            }, 2000);
        }

        // USAGE TRACKING
        function getTodayUsage() {
            const today = new Date().toDateString();
            return parseInt(localStorage.getItem('mtg_scans_' + today) || '0');
        }
        
        function getMonthlyUsage() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return parseInt(localStorage.getItem('mtg_monthly_scans_' + currentMonth) || '0');
        }
        
        function updateUsageDisplay() {
            const usage = getTodayUsage();
            const planDetails = {
                'free': { limit: 20, name: 'Free', color: '#6c757d' },
                'basic': { limit: 1000, name: 'Basic', color: '#4a90e2' },
                'pro': { limit: 10000, name: 'Pro', color: '#6f42c1' },
                'family': { limit: 10000, name: 'Family', color: '#fd7e14' },
                'store': { limit: 999999, name: 'Store', color: '#28a745' }
            };
            
            const plan = planDetails[userPlan] || planDetails[userTier] || planDetails['free'];
            const limit = plan.limit;
            const percentage = (usage / limit) * 100;
            
            document.getElementById('usageCount').textContent = usage;
            document.getElementById('usageLimit').textContent = limit;
            document.getElementById('remainingCount').textContent = Math.max(0, limit - usage);
            document.getElementById('usageBar').style.width = Math.min(percentage, 100) + '%';
            document.getElementById('userTierDisplay').textContent = plan.name;
            
            const upgradeBtn = document.getElementById('upgradeBtn');
            if (userTier === 'premium') {
                upgradeBtn.textContent = `💎 ${plan.name} Plan Active`;
                upgradeBtn.style.background = plan.color || '#28a745';
                upgradeBtn.style.cursor = 'default';
                upgradeBtn.onclick = null;
            } else {
                upgradeBtn.textContent = '💎 Upgrade - Starting $4.99';
                upgradeBtn.style.background = '#4a90e2';
                upgradeBtn.style.cursor = 'pointer';
                upgradeBtn.onclick = () => window.open('pricing.html', '_blank');
            }
            
            if (usage >= limit && userTier === 'free') {
                document.getElementById('usageBar').style.background = '#ff6b6b';
                return false;
            }
            return true;
        }
        
        function trackScan() {
            if (userTier === 'premium') {
                const planLimits = {
                    'basic': 1000, 'pro': 10000, 'family': 10000, 'store': 999999
                };
                const limit = planLimits[userPlan] || 999;
                const usage = getMonthlyUsage();
                
                if (usage >= limit) {
                    showToast(`You've reached your ${userPlan} plan limit of ${limit} scans this month.`, 'error');
                    return false;
                }
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                localStorage.setItem('mtg_monthly_scans_' + currentMonth, (usage + 1).toString());
            } else {
                if (!updateUsageDisplay()) {
                    showToast('Daily scan limit reached. Upgrade for unlimited scans!', 'warning');
                    setTimeout(() => window.open('pricing.html', '_blank'), 2000);
                    return false;
                }
                
                const today = new Date().toDateString();
                const currentUsage = getTodayUsage();
                localStorage.setItem('mtg_scans_' + today, (currentUsage + 1).toString());
            }
            
            updateUsageDisplay();
            return true;
        }

        // CAMERA SETUP
        async function initCamera() {
            try {
                console.log("📷 Setting up camera...");
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: 'environment' 
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    document.getElementById('cameraStatus').style.display = 'none';
                    document.getElementById('scanBtn').disabled = false;
                    console.log("✅ Camera ready");
                };
                
            } catch (error) {
                console.error("❌ Camera error:", error);
                document.getElementById('cameraStatus').innerHTML = "❌ Camera access denied<br><small>Please allow camera access and refresh</small>";
            }
        }

        // MODE SWITCHING
        function setMode(mode) {
            aiService.setMode(mode);
            
            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Show/hide manual input
            const manualInput = document.getElementById('manualInput');
            const videoContainer = document.querySelector('.video-container');
            const controls = document.querySelector('.controls');
            
            if (mode === 'manual') {
                manualInput.style.display = 'block';
                videoContainer.style.display = 'none';
                controls.style.display = 'none';
            } else {
                manualInput.style.display = 'none';
                videoContainer.style.display = 'block';
                controls.style.display = 'flex';
            }
            
            console.log(`🎯 Scan mode changed to: ${mode}`);
        }

        // SCANNING FUNCTIONS
        async function scanCard() {
            if (!trackScan()) return;
            
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = "🧠 AI Scanning...";
            
            try {
                const video = document.getElementById('video');
                const result = await aiService.scanCard(video);
                
                if (result.hasCard) {
                    displayResult(result);
                    showScanFeedback(result);
                } else {
                    document.getElementById('results').innerHTML = 
                        '<div class="placeholder">❌ No MTG card detected<br><small>Try different angle or lighting</small></div>';
                }
                
            } catch (error) {
                console.error("❌ Scan error:", error);
                document.getElementById('results').innerHTML = 
                    '<div class="placeholder" style="color: #ff6b6b;">⚠️ Scanning error - please try again</div>';
            }
            
            btn.disabled = false;
            btn.textContent = "🧠 AI Scan Card";
        }

        async function manualSearch() {
            const input = document.getElementById('manualSearch');
            const cardName = input.value.trim();
            
            if (!cardName) {
                showToast('Please enter a card name', 'warning');
                return;
            }
            
            if (!trackScan()) return;
            
            try {
                const result = await aiService.manualSearch(cardName);
                
                if (result.hasCard) {
                    displayResult(result);
                    input.value = '';
                } else {
                    showToast(result.message || 'Card not found', 'error');
                }
                
            } catch (error) {
                console.error("❌ Manual search error:", error);
                showToast('Search failed - please try again', 'error');
            }
        }

        function displayResult(card) {
            currentCard = card;
            
            const cardData = card.cardData;
            let priceDisplay = '';
            let setInfo = '';
            let modeInfo = '';
            
            // Price display
            if (cardData) {
                if (cardData.price && cardData.price !== 'Price unavailable') {
                    priceDisplay = `<div style="color: #4a90e2; font-weight: bold; margin: 10px 0;">💰 ${cardData.price}</div>`;
                } else {
                    priceDisplay = '<div style="color: #ffc107; font-size: 12px; margin: 10px 0;">⚠️ Price temporarily unavailable</div>';
                }
                
                // Set info
                if (cardData.set) {
                    setInfo = `<div style="color: #888; font-size: 12px;">Set: ${cardData.set} (${cardData.setCode})</div>`;
                }
            }
            
            // Mode info
            if (card.source.includes('accurate')) {
                modeInfo = '<div style="color: #28a745; font-size: 11px;">🎯 Accurate Mode: Exact edition detected</div>';
            } else if (card.source.includes('fast')) {
                modeInfo = '<div style="color: #ffc107; font-size: 11px;">⚡ Fast Mode: Quick name scan</div>';
            } else if (card.source.includes('manual')) {
                modeInfo = '<div style="color: #4a90e2; font-size: 11px;">✏️ Manual Search</div>';
            }
            
            document.getElementById('results').innerHTML = 
                '<div class="result-card">' +
                '<h4>' + card.name + '</h4>' +
                '<div class="confidence">Confidence: ' + card.confidence + '%</div>' +
                modeInfo +
                priceDisplay +
                setInfo +
                '<div style="margin: 15px 0; display: flex; gap: 8px; flex-wrap: wrap;">' +
                '<button onclick="saveToCollection()" class="btn" style="background: #28a745; color: white; padding: 8px 16px; font-size: 12px;">💾 Save</button>' +
                '<button onclick="retryDifferentMode()" class="btn" style="background: #ffc107; color: #000; padding: 8px 16px; font-size: 12px;">🔄 Retry</button>' +
                (cardData && cardData.scryfallUri ? 
                    `<button onclick="window.open('${cardData.scryfallUri}', '_blank')" class="btn" style="background: #4a90e2; color: white; padding: 8px 16px; font-size: 12px;">🔗 Scryfall</button>` : '') +
                '</div>' +
                '</div>';
        }

        function showScanFeedback(result) {
            const isAccurate = result.confidence >= 90;
            const feedbackHtml = `
                <div class="scan-feedback-bar">
                    <div>
                        ${isAccurate ? '✅' : '⚠️'} <strong>${result.name}</strong> 
                        ${isAccurate ? '(High confidence)' : '(Low confidence - check result)'}
                    </div>
                    <div class="feedback-actions">
                        <button class="correct-btn" onclick="hideFeedback()">✓ Correct</button>
                        <button class="retry-btn" onclick="retryDifferentMode()">🔄 Wrong card</button>
                    </div>
                </div>
            `;
            
            // Remove existing feedback
            const existingFeedback = document.querySelector('.scan-feedback-bar');
            if (existingFeedback) existingFeedback.remove();
            
            // Add new feedback
            const resultsDiv = document.getElementById('results');
            resultsDiv.insertAdjacentHTML('afterend', feedbackHtml);
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                const feedback = document.querySelector('.scan-feedback-bar');
                if (feedback) feedback.remove();
            }, 10000);
        }

        function hideFeedback() {
            const feedback = document.querySelector('.scan-feedback-bar');
            if (feedback) feedback.remove();
        }

        function retryDifferentMode() {
            hideFeedback();
            hideEditionPicker();
            
            // Suggest different mode
            const currentMode = aiService.currentMode;
            if (currentMode === 'fast') {
                setMode('accurate');
                showToast('Switched to Accurate mode for better edition detection', 'info');
            } else if (currentMode === 'accurate') {
                setMode('manual');
                showToast('Switched to Manual mode - enter card name manually', 'info');
            } else {
                setMode('fast');
                showToast('Switched to Fast mode for quick scanning', 'info');
            }
        }

        function saveToCollection() {
            if (!currentCard) return;
            
            const cardWithId = {
                ...currentCard,
                id: Date.now(),
                savedAt: new Date().toISOString(),
                collection: activeCollection
            };
            
            collections[activeCollection].unshift(cardWithId);
            localStorage.setItem('mtg_collections', JSON.stringify(collections));
            
            console.log("✅ Card saved:", cardWithId.name, "to", activeCollection);
            updateCollectionDisplay();
            hideFeedback();
            
            showToast(`✅ ${cardWithId.name} saved to ${activeCollection}!`, 'success');
        }

        // EDITION PICKER FUNCTIONS
        window.selectEdition = async function(cardName, setCode) {
            try {
                console.log(`🎯 Selected edition: ${cardName} from ${setCode}`);
                
                const url = `${aiService.scryfallUrl}/cards/search?q=!"${cardName}" set:${setCode.toLowerCase()}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.data && data.data.length > 0) {
                        const cardData = aiService.formatCardData(data.data[0]);
                        
                        const updatedResult = {
                            name: cardName,
                            confidence: 95,
                            source: 'edition_picker',
                            cardData: cardData
                        };
                        
                        displayResult(updatedResult);
                        hideEditionPicker();
                        showToast(`✅ Updated to ${setCode} edition`, 'success');
                    }
                }
                
            } catch (error) {
                console.error('❌ Edition selection error:', error);
                showToast('Failed to load selected edition', 'error');
            }
        };

        window.hideEditionPicker = function() {
            const picker = document.querySelector('.edition-picker');
            if (picker) picker.remove();
        };

        // COLLECTION MANAGEMENT
        function switchCollection(collectionName) {
            activeCollection = collectionName;
            
            document.querySelectorAll('.collection-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-collection="${collectionName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            updateCollectionDisplay();
            console.log(`📚 Switched to collection: ${collectionName}`);
        }

        function updateCollectionDisplay() {
            const collection = collections[activeCollection] || [];
            const container = document.getElementById('collectionCards');
            
            if (collection.length === 0) {
                container.innerHTML = 
                    `<div style="text-align: center; color: #888; padding: 40px;">
                        No cards in ${activeCollection} collection yet.<br>
                        Start scanning to build your collection!
                    </div>`;
            } else {
                container.innerHTML = collection.map(card => 
                    `<div class="collection-card">
                        <div class="card-name">${card.name}</div>
                        <div class="card-details">
                            <div>Confidence: ${card.confidence}%</div>
                            <div>Added: ${new Date(card.savedAt).toLocaleDateString()}</div>
                            ${card.cardData && card.cardData.set ? `<div>Set: ${card.cardData.set} (${card.cardData.setCode})</div>` : ''}
                            ${card.cardData && card.cardData.type_line ? `<div>Type: ${card.cardData.type_line}</div>` : ''}
                            <div style="font-size: 11px; color: #666; margin-top: 5px;">Source: ${card.source}</div>
                        </div>
                        ${card.cardData && card.cardData.price && card.cardData.price !== 'Price unavailable' ? 
                            `<div class="card-price">${card.cardData.price}</div>` :
                            '<div style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; display: inline-block;">No price</div>'
                        }
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button onclick="removeFromCollection('${card.id}')" class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">🗑️</button>
                            <button onclick="moveCard('${card.id}')" class="btn" style="background: #6f42c1; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">📁</button>
                        </div>
                    </div>`
                ).join('');
            }
            
            updateCollectionStats();
        }

        function updateCollectionStats() {
            const allCards = Object.values(collections).flat();
            const uniqueCards = [...new Set(allCards.map(card => card.name))];
            
            let totalValue = 0;
            let totalConfidence = 0;
            let priceCount = 0;
            
            allCards.forEach(card => {
                if (card.cardData && card.cardData.price && card.cardData.price !== 'Price unavailable') {
                    // Extract numeric value from price string
                    const priceMatch = card.cardData.price.match(/\d+\.?\d*/);
                    if (priceMatch) {
                        totalValue += parseFloat(priceMatch[0]);
                        priceCount++;
                    }
                }
                totalConfidence += card.confidence || 0;
            });
            
            const avgConfidence = allCards.length > 0 ? (totalConfidence / allCards.length).toFixed(0) : 0;
            
            document.getElementById('totalCards').textContent = allCards.length;
            document.getElementById('uniqueCards').textContent = uniqueCards.length;
            document.getElementById('totalValue').textContent = priceCount > 0 ? 
                '$' + totalValue.toFixed(2) : '$0.00';
            document.getElementById('scanAccuracy').textContent = allCards.length > 0 ? 
                avgConfidence + '%' : '--';
        }

        // AUTO MODE
        function toggleAutoMode() {
            autoMode = !autoMode;
            const btn = document.getElementById('autoBtn');
            
            if (autoMode) {
                btn.textContent = "⏹️ Stop";
                btn.style.background = "#dc3545";
                
                autoInterval = setInterval(() => {
                    if (!document.getElementById('scanBtn').disabled) {
                        scanCard();
                    }
                }, 5000);
                
                console.log("▶️ Auto mode started");
                showToast('Auto mode enabled - scanning every 5 seconds', 'info');
            } else {
                btn.textContent = "▶️ Auto";
                btn.style.background = "#28a745";
                
                if (autoInterval) {
                    clearInterval(autoInterval);
                    autoInterval = null;
                }
                
                console.log("⏹️ Auto mode stopped");
                showToast('Auto mode disabled', 'info');
            }
        }

        // UTILITY FUNCTIONS
        function showToast(message, type = 'info', duration = 3000) {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, duration);
        }

        function filterCollection() {
            const searchTerm = document.getElementById('collectionSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.collection-card');
            
            cards.forEach(card => {
                const cardName = card.querySelector('.card-name').textContent.toLowerCase();
                const cardDetails = card.querySelector('.card-details').textContent.toLowerCase();
                
                if (cardName.includes(searchTerm) || cardDetails.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // PLACEHOLDER FUNCTIONS (implement as needed)
        function exportCollection() {
            showToast('Export feature coming soon!', 'info');
        }

        function aiSortCollection() {
            showToast('AI Sort feature coming soon!', 'info');
        }

        function batchOperations() {
            showToast('Batch operations coming soon!', 'info');
        }

        function removeFromCollection(cardId) {
            collections[activeCollection] = collections[activeCollection].filter(card => card.id != cardId);
            localStorage.setItem('mtg_collections', JSON.stringify(collections));
            updateCollectionDisplay();
            showToast('Card removed', 'info');
        }

        function moveCard(cardId) {
            showToast('Move card feature coming soon!', 'info');
        }

        // EVENT LISTENERS & INITIALIZATION
        window.addEventListener('load', async function() {
            console.log("🚀 Initializing MTG Scanner Pro v3.1...");
            
            // Load saved collections
            const savedCollections = localStorage.getItem('mtg_collections');
            if (savedCollections) {
                try {
                    const loaded = JSON.parse(savedCollections);
                    collections = {
                        main: loaded.main || [],
                        commander: loaded.commander || [],
                        modern: loaded.modern || [],
                        standard: loaded.standard || [],
                        premium: loaded.premium || [],
                        trade: loaded.trade || [],
                        wishlist: loaded.wishlist || []
                    };
                } catch (e) {
                    console.log("❌ Error loading collections:", e);
                }
            }
            
            // Set up event listeners
            document.getElementById('scanBtn').addEventListener('click', scanCard);
            document.getElementById('autoBtn').addEventListener('click', toggleAutoMode);
            
            // Mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    setMode(this.dataset.mode);
                });
            });
            
            // Collection tabs
            document.querySelectorAll('.collection-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchCollection(this.dataset.collection);
                });
            });
            
            // Manual search enter key
            document.getElementById('manualSearch').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    manualSearch();
                }
            });
            
            // Start loading sequence
            runLoadingSequence();
            
            // Initialize displays
            updateUsageDisplay();
            updateCollectionDisplay();
            
            await initCamera();
            
            console.log("✅ MTG Scanner Pro v3.1 ready!");
            console.log("🔧 Fixed Features:");
            console.log("  - ✅ Multi-Mode Scanning: Fast/Accurate/Manual");
            console.log("  - ✅ Fixed API calls: Proper URL construction");
            console.log("  - ✅ Edition detection: With alternatives picker");
            console.log("  - ✅ Scan feedback: Retry and correction system");
            console.log("  - ✅ Streamlined UI: Removed deckbuilder");
            console.log("  - ✅ Smart Collections: Format-based organization");
        });

        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (autoInterval) clearInterval(autoInterval);
            const video = document.getElementById('video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });

        // Make functions globally available
        window.scanCard = scanCard;
        window.manualSearch = manualSearch;
        window.saveToCollection = saveToCollection;
        window.retryDifferentMode = retryDifferentMode;
        window.hideFeedback = hideFeedback;
        window.filterCollection = filterCollection;
        window.exportCollection = exportCollection;
        window.aiSortCollection = aiSortCollection;
        window.batchOperations = batchOperations;
        window.removeFromCollection = removeFromCollection;
        window.moveCard = moveCard;
    </script>
</body>
</html>