<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Scanner Pro v1.3 - Enhanced Collection Manager</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: white; min-height: 100vh; overflow-x: hidden;
        }
        
        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10000; opacity: 1; transition: opacity 1s ease-out;
        }
        .loading-screen.fade-out { opacity: 0; }
        
        .welcome-content { text-align: center; animation: welcomeSlide 2s ease-out; }
        .welcome-title {
            font-size: 3.5em; color: #4a90e2; margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(74, 144, 226, 0.5);
        }
        .welcome-subtitle { font-size: 1.3em; color: #888; margin-bottom: 30px; }
        .loading-spinner {
            width: 50px; height: 50px; border: 5px solid #333;
            border-top: 5px solid #4a90e2; border-radius: 50%; 
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        
        @keyframes welcomeSlide {
            0% { transform: translateY(50px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .app-container { 
            opacity: 0; transition: opacity 1s ease-in; padding: 20px;
            transform: translateY(20px);
        }
        .app-container.loaded { opacity: 1; transform: translateY(0); }
        
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #4a90e2; font-size: 2.5em; margin-bottom: 10px; }
        .header p { color: #888; font-size: 1.1em; }
        
        .usage-tracker {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 12px;
            padding: 15px; margin-bottom: 20px;
        }
        .usage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .usage-stats { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .usage-bar { background: #1a1a1a; height: 6px; border-radius: 3px; overflow: hidden; }
        .usage-fill { height: 100%; background: #4a90e2; transition: width 0.3s ease; }
        
        .main-content { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .section {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; position: relative;
        }
        .section h3 { color: #4a90e2; margin-bottom: 15px; font-size: 1.3em; }
        
        .video-container {
            position: relative; background: #000; border-radius: 8px; overflow: hidden;
            aspect-ratio: 16/9; margin-bottom: 15px;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        .camera-status {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; background: rgba(0,0,0,0.8);
            padding: 20px; border-radius: 8px;
        }
        
        .controls { display: flex; gap: 10px; }
        .btn {
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer;
            font-weight: bold; font-size: 14px; transition: all 0.3s ease;
            position: relative; overflow: hidden;
        }
        .btn-primary { background: #4a90e2; color: white; flex: 1; }
        .btn-primary:hover { background: #357abd; transform: translateY(-2px); }
        .btn-secondary { background: #28a745; color: white; padding: 12px 16px; }
        .btn:disabled { background: #666; cursor: not-allowed; }
        
        .result-card {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 8px;
            padding: 20px; text-align: center; position: relative;
            animation: resultSlideIn 0.6s ease-out;
        }
        .result-card h4 { color: #4a90e2; font-size: 1.4em; margin-bottom: 10px; }
        .confidence { color: #888; margin-bottom: 15px; }
        .placeholder {
            background: #2a2a2a; border-radius: 8px; padding: 40px;
            text-align: center; color: #888;
        }
        
        @keyframes resultSlideIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.9); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* COLLECTION SECTION */
        .binder-section {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; padding: 20px; margin-top: 20px;
        }
        .binder-tabs {
            display: flex; gap: 10px; overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a90e2 #1a1a1a;
            padding-bottom: 5px;
        }
        .binder-tabs::-webkit-scrollbar {
            height: 6px;
        }
        .binder-tabs::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 3px;
        }
        .binder-tabs::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 3px;
        }
        .binder-tab {
            background: #2a2a2a; border: 1px solid #4a90e2; border-radius: 8px;
            padding: 10px 15px; cursor: pointer; white-space: nowrap;
            transition: all 0.3s ease; min-width: fit-content; text-align: center;
            font-size: 13px; display: flex; align-items: center; gap: 5px;
        }
        .binder-tab.active { background: #4a90e2; color: white; }
        .binder-tab:hover { background: #3a3a3a; }
        
        .binder-content {
            background: #1a1a1a; border-radius: 8px; padding: 15px; min-height: 200px;
        }
        .binder-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .stat-item {
            background: #2a2a2a; border-radius: 6px; padding: 12px; text-align: center;
        }
        .stat-number { font-size: 24px; font-weight: bold; color: #4a90e2; }
        .stat-label { font-size: 12px; color: #888; }
        
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }
        .collection-card {
            background: #2a2a2a; border-radius: 12px; border: 1px solid #333; 
            padding: 15px; transition: all 0.3s ease; position: relative;
            overflow: hidden;
        }
        .collection-card:hover { 
            border-color: #4a90e2; transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.2);
        }
        .card-image-preview {
            width: 100%; height: 200px; object-fit: cover;
            border-radius: 8px; margin-bottom: 10px;
            background: #1a1a1a;
        }
        
        /* Scan feedback animations */
        @keyframes scanPulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes scanSuccess {
            0% { background: #4a90e2; }
            50% { background: #28a745; }
            100% { background: #4a90e2; }
        }
        
        .scan-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 167, 69, 0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 12px;
            font-size: 24px;
            font-weight: bold;
            z-index: 10000;
            animation: scanSuccess 0.5s ease;
        }
        
        /* View toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .view-btn {
            padding: 6px 12px;
            background: #2a2a2a;
            border: 1px solid #4a90e2;
            color: #4a90e2;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .view-btn.active {
            background: #4a90e2;
            color: white;
        }
        .card-name { 
            font-weight: bold; color: #4a90e2; margin-bottom: 8px; font-size: 16px;
        }
        .card-details { 
            font-size: 12px; color: #888; margin-bottom: 10px;
        }
        .card-price {
            background: #4a90e2; color: white; padding: 4px 8px; border-radius: 6px;
            font-size: 12px; font-weight: bold; display: inline-block;
        }
        
        /* ENHANCED PRICING MODAL */
        .modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95); display: none; align-items: center;
            justify-content: center; z-index: 1000; padding: 20px;
        }
        .modal-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border: 2px solid #4a90e2; border-radius: 20px;
            padding: 0; max-width: 1000px; width: 100%; max-height: 90vh; 
            overflow-y: auto; position: relative;
        }
        
        .modal-header {
            text-align: center; padding: 30px 30px 20px;
            border-bottom: 1px solid rgba(74, 144, 226, 0.3);
        }
        .modal-header h2 {
            color: #4a90e2; font-size: 2.5rem; margin-bottom: 10px;
        }
        .modal-header .tagline {
            color: #888; font-size: 1.1rem;
        }
        
        .pricing-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; padding: 25px;
        }
        
        .pricing-plan {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px; padding: 30px 20px; text-align: center;
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        
        .pricing-plan:hover {
            transform: translateY(-5px);
            border-color: #4a90e2;
            box-shadow: 0 15px 30px rgba(74, 144, 226, 0.2);
        }
        
        .plan-badge {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            padding: 5px 15px; border-radius: 15px; font-size: 12px; font-weight: bold;
        }
        .plan-badge.free { background: #28a745; }
        .plan-badge.popular { background: #4a90e2; }
        .plan-badge.family { background: #ff6b35; }
        
        .plan-name { font-size: 2rem; color: #4a90e2; margin-bottom: 15px; }
        .plan-price { font-size: 3rem; font-weight: bold; color: #fff; margin-bottom: 10px; }
        .plan-price small { font-size: 1rem; color: #888; }
        .plan-description { color: #888; margin-bottom: 20px; font-size: 14px; }
        
        .plan-features {
            list-style: none; text-align: left; margin-bottom: 25px;
        }
        .plan-features li {
            padding: 8px 0; color: #ccc; font-size: 14px;
            display: flex; align-items: center;
        }
        .plan-features li::before {
            content: '✓'; color: #28a745; font-weight: bold;
            margin-right: 10px; font-size: 16px;
        }
        
        .plan-button {
            width: 100%; padding: 15px; border: none; border-radius: 10px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: all 0.3s ease; text-transform: uppercase;
        }
        .plan-button.free { background: #28a745; color: white; }
        .plan-button.pro { background: #4a90e2; color: white; }
        .plan-button.family { background: #ff6b35; color: white; }
        
        .plan-button:hover { transform: translateY(-2px); opacity: 0.9; }
        .plan-button:disabled { background: #666; cursor: not-allowed; }
        
        .modal-close {
            position: absolute; top: 15px; right: 20px;
            background: none; border: none; color: #888;
            font-size: 24px; cursor: pointer; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center;
        }
        .modal-close:hover { color: #4a90e2; }
        
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); display: none;
            align-items: center; justify-content: center;
        }
        .loading-content { text-align: center; color: white; }
        .loading-spinner-modal {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid #4a90e2; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }

        /* SCAN PACKAGES MODAL STYLES */
        .scan-packages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 25px;
        }
        
        .scan-package-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .scan-package-card:hover {
            transform: translateY(-5px);
            border-color: #4a90e2;
            box-shadow: 0 15px 30px rgba(74, 144, 226, 0.2);
        }
        
        .scan-package-card.popular {
            border-color: #4a90e2;
            transform: scale(1.05);
        }
        
        .package-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #4a90e2;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .package-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .scan-count {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a90e2;
            margin: 10px 0;
        }
        
        .package-price {
            font-size: 2rem;
            color: #00e676;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .price-per-scan {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        
        .package-features {
            list-style: none;
            margin: 20px 0;
            text-align: left;
        }
        
        .package-features li {
            padding: 5px 0;
            color: #ccc;
            font-size: 14px;
        }
        
        .package-button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: #28a745;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .package-button:hover {
            transform: translateY(-2px);
            background: #218838;
        }
        
        .package-button.popular-btn {
            background: #4a90e2;
        }
        
        .package-button.popular-btn:hover {
            background: #357abd;
        }
        
        .package-info {
            background: rgba(74, 144, 226, 0.1);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 25px;
        }
        
        .package-info h4 {
            color: #4a90e2;
            margin-bottom: 10px;
        }
        
        .package-info p {
            color: #ccc;
            margin: 5px 0;
            font-size: 14px;
        }
        
        /* Add buy more scans button to usage tracker */
        .buy-scans-btn {
            background: #00e676;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .buy-scans-btn:hover {
            background: #00c853;
            transform: translateY(-1px);
        }

        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 12px 20px;
            border-radius: 6px;
            z-index: 10001;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        @media (max-width: 768px) { 
            .main-content { grid-template-columns: 1fr; }
            .welcome-title { font-size: 2.5em; }
            .pricing-grid { grid-template-columns: 1fr; }
            .modal-content { margin: 20px; }
        }
    </style>
</head>
<body>
    <!-- LOADING SCREEN -->
    <div id="loadingScreen" class="loading-screen">
        <div class="welcome-content">
            <div class="welcome-title">🃏 MTG Scanner Pro</div>
            <div class="welcome-subtitle">AI-Powered Card Recognition & Collection Management</div>
            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">Version 1.3 - Enhanced Collection Manager</div>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app-container">
        <div class="container">
            <div class="header">
                <h1>🃏 MTG Scanner Pro</h1>
                <p>AI-Powered Recognition • Real-Time Pricing • Digital Collection</p>
            </div>

            <div class="usage-tracker">
                <div class="usage-header">
                    <span style="color: #4a90e2; font-weight: bold;">
                        📊 <span id="usagePeriodLabel">Daily</span> Usage (<span id="userTierDisplay">Free</span>)
                    </span>
                    <button id="upgradeBtn" class="btn" style="background: #4a90e2; color: white; padding: 6px 12px; font-size: 12px; border-radius: 6px;">
                        💎 Upgrade - Starting $4.99
                    </button>
                </div>
                <div class="usage-stats">
                    <span style="font-weight: bold;"><span id="usageCount">0</span> / <span id="usageLimit">20</span> scans</span>
                    <span style="color: #888; font-size: 12px;"><span id="remainingCount">20</span> remaining</span>
                </div>
                <div class="usage-bar">
                    <div id="usageBar" class="usage-fill" style="width: 0%;"></div>
                </div>
            </div>

            <div class="main-content">
                <div class="section">
                    <h3>📷 Camera Feed</h3>
                    <div class="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <div id="cameraStatus" class="camera-status">📷 Initializing camera...</div>
                    </div>
                    <div class="controls">
                        <button id="scanBtn" class="btn btn-primary" disabled>🧠 AI Scan Card</button>
                        <button id="autoBtn" class="btn btn-secondary">▶️ Auto</button>
                    </div>
                </div>

                <div class="section">
                    <h3>🎯 Scan Results</h3>
                    <div id="results">
                        <div class="placeholder">📷 Point camera at MTG card and click scan</div>
                    </div>
                </div>
            </div>

            <!-- DIGITAL COLLECTION SECTION -->
            <div class="binder-section">
                <h3 style="color: #4a90e2; margin-bottom: 20px;">📚 Digital Collection</h3>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="binder-tabs" style="flex: 1;">
                        <div class="binder-tab active" data-binder="main">📂 Main</div>
                        <div class="binder-tab" data-binder="premium">💎 Premium</div>
                        <div class="binder-tab" data-binder="trade">🔄 Trade</div>
                        <div class="binder-tab" data-binder="edh">👑 EDH</div>
                        <div class="binder-tab" data-binder="modern">⚡ Modern</div>
                        <div class="binder-tab" data-binder="standard">🎯 Standard</div>
                        <div class="binder-tab" data-binder="wishlist">⭐ Wishlist</div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-left: 20px;">
                        <button onclick="exportCollection()" class="btn" style="background: #28a745; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                            📤 Export
                        </button>
                        <button onclick="aiSortCollection()" class="btn" style="background: #6f42c1; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                            🤖 AI Sort
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="collectionSearch" placeholder="🔍 Search cards..." 
                           style="flex: 1; padding: 8px 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
                                  border-radius: 6px; color: white; font-size: 14px;"
                           onkeyup="filterCollection()">
                    <button onclick="batchOperations()" class="btn" style="background: #fd7e14; color: white; padding: 8px 16px; border-radius: 6px; font-size: 14px;">
                        ⚡ Batch Actions
                    </button>
                </div>
                
                <div class="binder-content">
                    <div class="binder-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalCards">0</div>
                            <div class="stat-label">Total Cards</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="uniqueCards">0</div>
                            <div class="stat-label">Unique Cards</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalValue">$0.00</div>
                            <div class="stat-label">Collection Value</div>
                        </div>
                    </div>
                    
                    <div id="binderCards" class="card-grid">
                        <div style="text-align: center; color: #888; padding: 40px;">
                            No cards in this collection yet. Start scanning to build your collection!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PRICING MODAL -->
    <div id="upgradeModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeUpgradeModal()">&times;</button>
            
            <div class="modal-header">
                <h2>🚀 Choose Your Plan</h2>
                <div class="tagline">Unlock the full power of MTG Scanner Pro</div>
            </div>
            
            <div class="pricing-grid">
                <!-- Free Plan -->
                <div class="pricing-plan">
                    <div class="plan-badge free">FREE FOREVER</div>
                    <div class="plan-name">Free</div>
                    <div class="plan-price">$0<small>/month</small></div>
                    <div class="plan-description">Perfect for casual players</div>
                    
                    <ul class="plan-features">
                        <li>20 card scans per day</li>
                        <li>98% recognition accuracy</li>
                        <li>7+ custom binders/folders</li>
                        <li>AI card sorting & grouping</li>
                        <li>Export to all formats (Moxfield, Archidekt, TXT, CSV, JSON)</li>
                        <li>Batch operations & filtering</li>
                        <li>Collection search & statistics</li>
                        <li>Mobile & desktop scanning</li>
                        <li>Community support</li>
                    </ul>
                    
                    <button class="plan-button free" onclick="selectFreePlan()">
                        Continue with Free
                    </button>
                </div>
                
                <!-- Basic Plan -->
                <div class="pricing-plan">
                    <div class="plan-name">Basic</div>
                    <div class="plan-price">$4.99<small>/month</small></div>
                    <div class="plan-description">Great for regular players</div>
                    
                    <ul class="plan-features">
                        <li>1,000 card scans per month</li>
                        <li>98% recognition accuracy</li>
                        <li>Unlimited collection storage</li>
                        <li>All export formats</li>
                        <li>Email support</li>
                        <li>Price tracking alerts</li>
                    </ul>
                    
                    <button class="plan-button pro" onclick="selectPlan('basic', 499)">
                        Choose Basic - $4.99/month
                    </button>
                </div>
                
                <!-- Pro Plan -->
                <div class="pricing-plan">
                    <div class="plan-badge popular">MOST POPULAR</div>
                    <div class="plan-name">Pro</div>
                    <div class="plan-price">$9.99<small>/month</small></div>
                    <div class="plan-description">Best for serious collectors</div>
                    
                    <ul class="plan-features">
                        <li>10,000 card scans per month</li>
                        <li>98% recognition accuracy</li>
                        <li>Advanced analytics dashboard</li>
                        <li>Real-time price tracking</li>
                        <li>Market trend analysis</li>
                        <li>Portfolio management</li>
                        <li>Priority support</li>
                        <li>API access</li>
                    </ul>
                    
                    <button class="plan-button pro" onclick="selectPlan('pro', 999)">
                        Choose Pro - $9.99/month
                    </button>
                </div>
                
                <!-- Family Plan -->
                <div class="pricing-plan">
                    <div class="plan-badge family">FAMILY PLAN</div>
                    <div class="plan-name">Family</div>
                    <div class="plan-price">$14.99<small>/month</small></div>
                    <div class="plan-description">Perfect for MTG families</div>
                    
                    <ul class="plan-features">
                        <li>3 user accounts included</li>
                        <li>10,000 scans shared between users</li>
                        <li>All Pro features included</li>
                        <li>Shared collections</li>
                        <li>Family analytics</li>
                        <li>Individual user tracking</li>
                        <li>Parental controls</li>
                        <li>Family support</li>
                    </ul>
                    
                    <button class="plan-button family" onclick="selectPlan('family', 1499)">
                        Choose Family - $14.99/month
                    </button>
                </div>
                
                <!-- Store Plan -->
                <div class="pricing-plan">
                    <div class="plan-badge" style="background: #ff6b35;">BUSINESS</div>
                    <div class="plan-name">Store</div>
                    <div class="plan-price">$49.99<small>/month</small></div>
                    <div class="plan-description">Perfect for game stores</div>
                    
                    <ul class="plan-features">
                        <li>Unlimited card scanning</li>
                        <li>Multi-user store management</li>
                        <li>Inventory tracking system</li>
                        <li>Customer collection sync</li>
                        <li>Point-of-sale integration</li>
                        <li>Bulk pricing tools</li>
                        <li>Advanced analytics</li>
                        <li>Priority business support</li>
                    </ul>
                    
                    <button class="plan-button" style="background: #ff6b35; color: white;" onclick="selectPlan('store', 4999)">
                        Choose Store - $49.99/month
                    </button>
                </div>
            </div>
            
            <!-- Loading Overlay -->
            <div id="checkoutLoading" class="loading-overlay">
                <div class="loading-content">
                    <div class="loading-spinner-modal"></div>
                    <div>Creating secure checkout...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- BUY MORE SCANS MODAL -->
    <div id="scanPackagesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <button class="modal-close" onclick="closeScanPackagesModal()">&times;</button>
            
            <div class="modal-header">
                <h2>⚡ Buy More Scans</h2>
                <div class="tagline">One-time scan packages • No subscription required</div>
            </div>
            
            <div class="scan-packages-grid">
                <!-- Starter Pack -->
                <div class="scan-package-card">
                    <div class="package-icon">📦</div>
                    <h3>Starter Pack</h3>
                    <div class="scan-count">50 Scans</div>
                    <div class="package-price">$2.99</div>
                    <div class="price-per-scan">$0.06 per scan</div>
                    <ul class="package-features">
                        <li>✓ Never expires</li>
                        <li>✓ Use anytime</li>
                        <li>✓ Instant activation</li>
                    </ul>
                    <button class="package-button" onclick="purchaseScanPackage('starter', 299, 50)">
                        Buy 50 Scans
                    </button>
                </div>
                
                <!-- Value Pack -->
                <div class="scan-package-card popular">
                    <div class="package-badge">BEST VALUE</div>
                    <div class="package-icon">💎</div>
                    <h3>Value Pack</h3>
                    <div class="scan-count">200 Scans</div>
                    <div class="package-price">$9.99</div>
                    <div class="price-per-scan">$0.05 per scan</div>
                    <ul class="package-features">
                        <li>✓ Never expires</li>
                        <li>✓ Use anytime</li>
                        <li>✓ Save 17%</li>
                        <li>✓ Most popular choice</li>
                    </ul>
                    <button class="package-button popular-btn" onclick="purchaseScanPackage('value', 999, 200)">
                        Buy 200 Scans
                    </button>
                </div>
                
                <!-- Power Pack -->
                <div class="scan-package-card">
                    <div class="package-icon">🚀</div>
                    <h3>Power Pack</h3>
                    <div class="scan-count">500 Scans</div>
                    <div class="package-price">$19.99</div>
                    <div class="price-per-scan">$0.04 per scan</div>
                    <ul class="package-features">
                        <li>✓ Never expires</li>
                        <li>✓ Use anytime</li>
                        <li>✓ Save 33%</li>
                        <li>✓ Perfect for stores</li>
                    </ul>
                    <button class="package-button" onclick="purchaseScanPackage('power', 1999, 500)">
                        Buy 500 Scans
                    </button>
                </div>
            </div>
            
            <div class="package-info">
                <h4>How it works:</h4>
                <p>• Scan packages never expire - use them at your own pace</p>
                <p>• Packages stack with your daily free scans</p>
                <p>• One-time payment - no subscription required</p>
                <p>• Instant activation after purchase</p>
            </div>
            
            <!-- Loading Overlay -->
            <div id="scanPackageLoading" class="loading-overlay">
                <div class="loading-content">
                    <div class="loading-spinner-modal"></div>
                    <div>Creating secure checkout...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 🚀 MTG SCANNER PRO v1.3 - ENHANCED COLLECTION MANAGER WITH EDITION DETECTION
        console.log("🚀 MTG Scanner Pro v1.3 Loading (Enhanced Collection Manager with Edition Detection)...");

        // STRIPE CONFIGURATION
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51RhfZz2MTNp7aGECjmpnQRWFR0hQSNZvcxOp5nKBhclf90P9lAieTCTrCYYeh4537aeDXDM4N7LVo7SNogEEHhVH00mBdEFiJ4';
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);

        // ENHANCED MTG AI SERVICE WITH EDITION DETECTION AND SCRYFALL FIX
        class EnhancedMTGService {
            constructor() {
                this.apiKey = 'AIzaSyBtqyUy1X3BdNtUAW88QZWbtqI39MbUDdk';
                this.geminiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
                this.scryfallUrl = 'https://api.scryfall.com';
                this.lastApiCall = 0;
                this.minInterval = 3000;
                this.errors = 0;
            }

            async scanCard(video) {
                try {
                    const now = Date.now();
                    if (now - this.lastApiCall < this.minInterval) {
                        await new Promise(r => setTimeout(r, this.minInterval - (now - this.lastApiCall)));
                    }
                    this.lastApiCall = Date.now();

                    const imageData = this.captureFrame(video);
                    const result = await this.callGemini(imageData);
                    
                    if (result.hasCard) {
                        // Pass set info to getCardData
                        result.cardData = await this.getCardData(result.name, result.setInfo);
                    }
                    
                    this.errors = 0;
                    return result;
                } catch (error) {
                    console.error("🚨 AI error:", error);
                    this.errors++;
                    
                    if (this.errors > 3) {
                        console.warn('⚠️ Too many errors, using fallback');
                        return this.getFallback();
                    }
                    
                    return {
                        hasCard: false,
                        message: "Scanner temporarily unavailable - please try again",
                        error: true
                    };
                }
            }

            async callGemini(imageData) {
                const body = {
                    contents: [{
                        parts: [
                            { 
                                text: `Analyze this Magic: The Gathering card image and identify:
1. CARD_NAME: [exact card name]
2. SET_SYMBOL: [describe the expansion symbol in center-right below illustration, note color: black=common, silver=uncommon, gold=rare, orange/red=mythic]
3. SET_CODE: [if identifiable, like DMU, BRO, ONE, or for core sets: 4ED, 5ED, 6ED, 7ED, 8ED, 9ED, 10E, M10, M11, etc.]
4. CARD_NUMBER: [collector number if visible at bottom left, format: "123/350"]
5. COPYRIGHT_YEAR: [year at bottom of card]
6. BORDER_COLOR: [black or white border]
7. SPECIAL_FEATURES: [any distinctive features noted below]
8. LANGUAGE: [language if not English]
9. CONFIDENCE: [80-99]

If no MTG card detected, respond: NO_MTG_CARD

CRITICAL IDENTIFICATION POINTS:

For MODERN cards (with expansion symbols):
- Expansion symbol location: center-right of card, below illustration
- Symbol color indicates rarity
- Collector info at bottom: "123/350 • DMU • EN"
- Set code usually 3 letters

For OLDER cards (no expansion symbols):
- Alpha: BLACK border + VERY rounded corners (more than normal)
- Beta: BLACK border + normal corners
- Unlimited: WHITE border + DOUBLE beveled line inside art box frame
- Revised (3rd): WHITE border + SINGLE line inside art box frame
- 4th Edition: WHITE border + copyright 1995
- 5th Edition: WHITE border + copyright 1997
- Core sets 6th-9th: Look for Roman numerals (VI, VII, VIII, IX)
- Core sets M10+: "M" followed by year (M10, M11, M12, etc.)

Additional clues:
- Tap symbol: Old curved arrow vs modern T symbol
- Mana symbols in text vs written out ("2 white mana" vs {W}{W})
- Card frame: Old frame (pre-8th Edition) vs Modern frame (8th Edition+)
- Foil stamp (M15+): Holographic stamp at bottom for rares/mythics

Common modern set symbols:
- Phyrexia symbol = Phyrexia: All Will Be One (ONE)
- Gear = The Brothers' War (BRO)  
- Triangle with lines = Dominaria United (DMU)
- Shield with sword = Dominaria (DOM)
- Planeswalker symbol = War of the Spark (WAR)
- City gate = Ravnica sets (GRN, RNA)
- Hourglass = Time Spiral (TSP)` 
                            },
                            { inline_data: { mime_type: "image/jpeg", data: imageData } }
                        ]
                    }]
                };

                const response = await fetch(this.geminiUrl + '?key=' + this.apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                
                console.log("🧠 Gemini raw response:", text);
                
                if (text.includes('NO_MTG_CARD')) {
                    return { hasCard: false, message: "No MTG card detected" };
                }

                // Parse the enhanced response
                const nameMatch = text.match(/CARD_NAME:\s*([^\n]+?)(?:\s*SET_SYMBOL:|$)/i);
                const setSymbolMatch = text.match(/SET_SYMBOL:\s*([^\n]+)/i);
                const setCodeMatch = text.match(/SET_CODE:\s*([^\n]+)/i);
                const numberMatch = text.match(/CARD_NUMBER:\s*([^\n]+)/i);
                const yearMatch = text.match(/COPYRIGHT_YEAR:\s*([^\n]+)/i);
                const borderMatch = text.match(/BORDER_COLOR:\s*([^\n]+)/i);
                const specialMatch = text.match(/SPECIAL_FEATURES:\s*([^\n]+)/i);
                const languageMatch = text.match(/LANGUAGE:\s*([^\n]+)/i);
                const confMatch = text.match(/CONFIDENCE:\s*(\d+)/i);

                if (nameMatch) {
                    // Clean the card name
                    let cardName = nameMatch[1].trim();
                    cardName = cardName.replace(/\s*CONFIDENCE:.*$/i, '').trim();
                    cardName = cardName.replace(/\s+\d+\s*$/, '').trim();
                    
                    const setInfo = {
                        symbol: setSymbolMatch?.[1]?.trim(),
                        code: setCodeMatch?.[1]?.trim().toUpperCase(),
                        number: numberMatch?.[1]?.trim(),
                        year: yearMatch?.[1]?.trim(),
                        borderColor: borderMatch?.[1]?.trim(),
                        specialFeatures: specialMatch?.[1]?.trim(),
                        language: languageMatch?.[1]?.trim() || 'English'
                    };
                    
                    // Try to identify early editions based on features
                    if (!setInfo.code || setInfo.code === 'Unknown') {
                        if (setInfo.borderColor === 'black' && setInfo.specialFeatures?.includes('rounded corners')) {
                            setInfo.code = 'LEA'; // Alpha
                            setInfo.inferredSet = 'Limited Edition Alpha';
                        } else if (setInfo.borderColor === 'black' && !setInfo.symbol) {
                            setInfo.code = 'LEB'; // Beta
                            setInfo.inferredSet = 'Limited Edition Beta';
                        } else if (setInfo.borderColor === 'white' && setInfo.specialFeatures?.includes('double')) {
                            setInfo.code = '2ED'; // Unlimited
                            setInfo.inferredSet = 'Unlimited Edition';
                        } else if (setInfo.borderColor === 'white' && setInfo.year === '1995') {
                            setInfo.code = '4ED'; // 4th Edition
                            setInfo.inferredSet = 'Fourth Edition';
                        } else if (setInfo.borderColor === 'white' && setInfo.year === '1997') {
                            setInfo.code = '5ED'; // 5th Edition
                            setInfo.inferredSet = 'Fifth Edition';
                        }
                    }
                    
                    console.log("📝 Parsed card:", cardName);
                    console.log("🎯 Set info:", setInfo);
                    
                    return {
                        hasCard: true,
                        name: cardName,
                        setInfo: setInfo,
                        confidence: parseInt(confMatch?.[1] || '85'),
                        source: 'gemini_ai'
                    };
                }

                return { hasCard: false, message: "Could not parse response" };
            }

            async getCardData(cardName, setInfo = null) {
                try {
                    console.log(`💰 Fetching real data for: "${cardName}"`);
                    if (setInfo) {
                        console.log(`📦 With set info:`, setInfo);
                    }
                    
                    // Clean the card name
                    const cleanCardName = cardName
                        .trim()
                        .replace(/[^\w\s,'-]/g, '')
                        .replace(/\s+/g, ' ');
                    
                    let response;
                    let searchUrl;
                    
                    // Strategy 1: If we have a set code, try specific printing first
                    if (setInfo?.code && setInfo.code !== 'Unknown') {
                        console.log(`🎯 Trying specific set: ${setInfo.code}`);
                        searchUrl = `${this.scryfallUrl}/cards/named?exact=${encodeURIComponent(cleanCardName)}&set=${setInfo.code}`;
                        response = await fetch(searchUrl);
                        
                        if (response.ok) {
                            console.log('✅ Found exact card in specified set!');
                        }
                    }
                    
                    // Strategy 2: If we have collector number and set, try direct lookup
                    if (!response?.ok && setInfo?.code && setInfo?.number) {
                        console.log(`🎯 Trying collector number: ${setInfo.code} #${setInfo.number}`);
                        searchUrl = `${this.scryfallUrl}/cards/${setInfo.code.toLowerCase()}/${setInfo.number}`;
                        response = await fetch(searchUrl);
                    }
                    
                    // Strategy 3: Try exact name match without set
                    if (!response?.ok) {
                        console.log('⚠️ Set-specific search failed, trying general exact match');
                        searchUrl = `${this.scryfallUrl}/cards/named?exact=${encodeURIComponent(cleanCardName)}`;
                        response = await fetch(searchUrl);
                    }
                    
                    // Strategy 4: Try fuzzy search
                    if (!response.ok && response.status === 404) {
                        console.log('⚠️ Exact match failed, trying fuzzy search...');
                        searchUrl = `${this.scryfallUrl}/cards/named?fuzzy=${encodeURIComponent(cleanCardName)}`;
                        response = await fetch(searchUrl);
                    }
                    
                    // Strategy 5: Try autocomplete
                    if (!response.ok && response.status === 404) {
                        console.log('⚠️ Fuzzy search failed, trying autocomplete...');
                        const autocompleteUrl = `${this.scryfallUrl}/cards/autocomplete?q=${encodeURIComponent(cleanCardName)}`;
                        const autocompleteResponse = await fetch(autocompleteUrl);
                        
                        if (autocompleteResponse.ok) {
                            const suggestions = await autocompleteResponse.json();
                            if (suggestions.data && suggestions.data.length > 0) {
                                const suggestedName = suggestions.data[0];
                                console.log(`💡 Using autocomplete suggestion: ${suggestedName}`);
                                searchUrl = `${this.scryfallUrl}/cards/named?exact=${encodeURIComponent(suggestedName)}`;
                                response = await fetch(searchUrl);
                            }
                        }
                    }
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('✅ Scryfall data received:', data.name, 'from', data.set_name);
                        
                        // Get USD price with multiple fallbacks
                        let price = null;
                        if (data.prices) {
                            price = data.prices.usd || 
                                   data.prices.usd_foil || 
                                   data.prices.eur || 
                                   data.prices.tix;
                                   
                            if (price) {
                                price = `$${parseFloat(price).toFixed(2)}`;
                            } else {
                                price = 'Price not available';
                            }
                        }
                        
                        // Include edition detection results
                        const editionInfo = {
                            identifiedSet: data.set_name,
                            identifiedCode: data.set,
                            aiDetectedCode: setInfo?.code,
                            matchConfidence: (setInfo?.code === data.set.toUpperCase()) ? 'High' : 'Medium'
                        };
                        
                        return {
                            name: data.name,
                            image: data.image_uris ? data.image_uris.normal : null,
                            price: price,
                            set: data.set_name || 'Unknown',
                            setCode: data.set ? data.set.toUpperCase() : '',
                            rarity: data.rarity || 'unknown',
                            scryfallId: data.id,
                            scryfallUri: data.scryfall_uri || data.uri,
                            cmc: data.cmc || 0,
                            colors: data.colors || [],
                            type_line: data.type_line || '',
                            collectorNumber: data.collector_number || '',
                            releaseDate: data.released_at || '',
                            oracle_text: data.oracle_text || '',
                            artist: data.artist || 'Unknown',
                            editionInfo: editionInfo,
                            borderColor: data.border_color || 'black',
                            frame: data.frame || 'modern',
                            language: data.lang || 'en',
                            foil: data.foil || false,
                            nonfoil: data.nonfoil || true
                        };
                    } else {
                        console.error('❌ Scryfall error:', response.status, response.statusText);
                        const errorData = await response.json().catch(() => ({}));
                        console.error('Error details:', errorData);
                        
                        // Return partial data even if Scryfall fails
                        return {
                            name: cleanCardName,
                            price: 'Price unavailable',
                            set: setInfo?.code || 'Unknown',
                            setCode: setInfo?.code || '',
                            scryfallError: true,
                            errorMessage: errorData.details || 'Card not found',
                            editionInfo: {
                                aiDetectedCode: setInfo?.code,
                                aiDetectedSymbol: setInfo?.symbol,
                                note: 'Could not verify with Scryfall'
                            }
                        };
                    }
                    
                } catch (error) {
                    console.error('❌ Scryfall fetch error:', error);
                    return {
                        name: cardName,
                        price: 'Price unavailable',
                        set: 'Unknown',
                        scryfallError: true,
                        errorMessage: error.message
                    };
                }
            }

            captureFrame(video) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                ctx.drawImage(video, 0, 0);
                return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            }

            getFallback() {
                console.warn('⚠️ Using fallback detection - Gemini API issues');
                const cards = ["Lightning Bolt", "Black Lotus", "Sol Ring", "Counterspell"];
                return {
                    hasCard: true,
                    name: cards[Math.floor(Math.random() * cards.length)],
                    confidence: 85 + Math.floor(Math.random() * 10),
                    source: 'fallback',
                    isFallback: true,
                    setInfo: {
                        code: 'Unknown',
                        symbol: 'Unable to detect',
                        note: 'Fallback mode - edition detection unavailable'
                    }
                };
            }
        }

        // GLOBAL VARIABLES
        let currentCard = null;
        let collections = { 
            main: [], 
            premium: [], 
            trade: [],
            edh: [],
            modern: [],
            standard: [],
            wishlist: [],
            custom1: [],
            custom2: []
        };
        let activeBinder = 'main';
        let autoMode = false;
        let autoInterval = null;
        let userTier = localStorage.getItem('mtg_user_tier') || 'free';
        let userPlan = localStorage.getItem('mtg_plan_type') || 'free';
        let aiService = new EnhancedMTGService();
        
        // LOADING SEQUENCE
        function runLoadingSequence() {
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                const mainApp = document.getElementById('mainApp');
                
                loadingScreen.classList.add('fade-out');
                mainApp.classList.add('loaded');
                
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 1000);
            }, 2000);
        }

        // USAGE TRACKING
        function getTodayUsage() {
            const today = new Date().toDateString();
            return parseInt(localStorage.getItem('mtg_scans_' + today) || '0');
        }
        
        function getMonthlyUsage() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            return parseInt(localStorage.getItem('mtg_monthly_scans_' + currentMonth) || '0');
        }

        // Track purchased scan packages
        function getPurchasedScans() {
            return parseInt(localStorage.getItem('mtg_purchased_scans') || '0');
        }

        function addPurchasedScans(amount) {
            const current = getPurchasedScans();
            localStorage.setItem('mtg_purchased_scans', (current + amount).toString());
            updateUsageDisplay();
        }
        
        function updateUsageDisplay() {
            const dailyUsage = getTodayUsage();
            const purchasedScans = getPurchasedScans();
            const monthlyUsage = getMonthlyUsage();
            
            const planDetails = {
                'free': { limit: 20, name: 'Free', color: '#6c757d', period: 'daily' },
                'basic': { limit: 1000, name: 'Basic', color: '#4a90e2', period: 'monthly' },
                'pro': { limit: 10000, name: 'Pro', color: '#6f42c1', period: 'monthly' },
                'family': { limit: 10000, name: 'Family', color: '#fd7e14', period: 'monthly' },
                'store': { limit: 999999, name: 'Store', color: '#28a745', period: 'monthly' }
            };
            
            const plan = planDetails[userPlan] || planDetails[userTier] || planDetails['free'];
            
            // For free users, check both daily limit and purchased scans
            if (userTier === 'free') {
                const dailyRemaining = Math.max(0, plan.limit - dailyUsage);
                const totalAvailable = dailyRemaining + purchasedScans;
                
                document.getElementById('usageCount').textContent = dailyUsage;
                document.getElementById('usageLimit').textContent = plan.limit;
                document.getElementById('remainingCount').textContent = totalAvailable;
                
                // Add purchased scans indicator
                if (purchasedScans > 0) {
                    const usageHeader = document.querySelector('.usage-header span');
                    usageHeader.innerHTML = `📊 Daily Usage (Free) + <span style="color: #00e676;">${purchasedScans} purchased</span>`;
                }
                
                const percentage = (dailyUsage / plan.limit) * 100;
                document.getElementById('usageBar').style.width = Math.min(percentage, 100) + '%';
                
                // Add buy more scans button if not already present
                if (!document.getElementById('buyScansBtn')) {
                    const upgradeBtn = document.getElementById('upgradeBtn');
                    const buyScansBtn = document.createElement('button');
                    buyScansBtn.id = 'buyScansBtn';
                    buyScansBtn.className = 'buy-scans-btn';
                    buyScansBtn.textContent = '⚡ Buy Scans';
                    buyScansBtn.onclick = openScanPackagesModal;
                    upgradeBtn.parentNode.insertBefore(buyScansBtn, upgradeBtn.nextSibling);
                }
                
            } else {
                // Premium users see monthly usage
                const usage = monthlyUsage;
                const percentage = (usage / plan.limit) * 100;
                
                document.getElementById('usageCount').textContent = usage;
                document.getElementById('usageLimit').textContent = plan.limit;
                document.getElementById('remainingCount').textContent = Math.max(0, plan.limit - usage);
                document.getElementById('usageBar').style.width = Math.min(percentage, 100) + '%';
            }
            
            document.getElementById('userTierDisplay').textContent = plan.name;
            document.getElementById('usagePeriodLabel').textContent = plan.period === 'monthly' ? 'Monthly' : 'Daily';
            
            // Change upgrade button based on plan
            const upgradeBtn = document.getElementById('upgradeBtn');
            if (userTier === 'premium') {
                upgradeBtn.textContent = `💎 ${plan.name} Plan Active`;
                upgradeBtn.style.background = plan.color || '#28a745';
                upgradeBtn.style.cursor = 'default';
                upgradeBtn.onclick = null;
            } else {
                upgradeBtn.textContent = '💎 Upgrade - Starting $4.99';
                upgradeBtn.style.background = '#4a90e2';
                upgradeBtn.style.cursor = 'pointer';
                upgradeBtn.onclick = openUpgradeModal;
            }
            
            if (dailyUsage >= plan.limit && userTier === 'free' && purchasedScans === 0) {
                document.getElementById('usageBar').style.background = '#ff6b6b';
                return false;
            }
            return true;
        }
        
        function trackScan() {
            const purchasedScans = getPurchasedScans();
            
            // Premium users
            if (userTier === 'premium') {
                const planLimits = {
                    'basic': 1000,
                    'pro': 10000,
                    'family': 10000,
                    'store': 999999
                };
                const limit = planLimits[userPlan] || 999;
                const usage = getMonthlyUsage();
                
                if (usage >= limit) {
                    alert(`You've reached your ${userPlan} plan limit of ${limit} scans this month.`);
                    return false;
                }
                
                const currentMonth = new Date().toISOString().slice(0, 7);
                localStorage.setItem('mtg_monthly_scans_' + currentMonth, (usage + 1).toString());
            } else {
                // Free users - check daily limit first, then purchased scans
                const dailyUsage = getTodayUsage();
                
                if (dailyUsage < 20) {
                    // Use daily free scan
                    const today = new Date().toDateString();
                    localStorage.setItem('mtg_scans_' + today, (dailyUsage + 1).toString());
                } else if (purchasedScans > 0) {
                    // Use purchased scan
                    localStorage.setItem('mtg_purchased_scans', (purchasedScans - 1).toString());
                    showProfessionalToast('⚡ Using purchased scan', 'info', 2000);
                } else {
                    // No scans available
                    openScanPackagesModal();
                    return false;
                }
            }
            
            updateUsageDisplay();
            return true;
        }

        // PRICING FUNCTIONS
        function openUpgradeModal() {
            if (userTier === 'premium') {
                alert(`You already have the ${userPlan} plan active!`);
                return;
            }
            document.getElementById('upgradeModal').style.display = 'flex';
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').style.display = 'none';
        }
        
        function selectFreePlan() {
            alert('You are already using the Free plan! Enjoy 20 daily scans.');
            closeUpgradeModal();
        }
        
        async function selectPlan(planType, priceInCents) {
            try {
                console.log(`🚀 REAL STRIPE CHECKOUT: ${planType}, ${priceInCents/100}`);
                
                document.getElementById('checkoutLoading').style.display = 'flex';
                
                const stripePaymentUrls = {
                    'basic': 'https://buy.stripe.com/14A6oAcY64PZ7319qE48004',
                    'pro': 'https://buy.stripe.com/5kQ7sEf6edmv2ML6es48001',
                    'family': 'https://buy.stripe.com/fZu28k0bkeqzgDBdGU48000',
                    'store': 'https://buy.stripe.com/bJebIU1foaaj875cCQ48003'
                };
                
                setTimeout(() => {
                    console.log(`🚀 Redirecting to Stripe checkout: ${stripePaymentUrls[planType]}`);
                    window.location.href = stripePaymentUrls[planType];
                    
                    setTimeout(() => {
                        document.getElementById('checkoutLoading').style.display = 'none';
                    }, 2000);
                    
                }, 1000);
                
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Something went wrong: ' + error.message);
                document.getElementById('checkoutLoading').style.display = 'none';
            }
        }

        // Scan packages modal functions
        function openScanPackagesModal() {
            document.getElementById('scanPackagesModal').style.display = 'flex';
        }

        function closeScanPackagesModal() {
            document.getElementById('scanPackagesModal').style.display = 'none';
        }

        // Purchase scan package with Stripe
        async function purchaseScanPackage(packageType, priceInCents, scanCount) {
            try {
                console.log(`🎯 Purchasing ${packageType} package: ${scanCount} scans for $${priceInCents/100}`);
                
                document.getElementById('scanPackageLoading').style.display = 'flex';
                
                // Real Stripe Payment Links for scan packages
                const scanPackageUrls = {
                    'starter': 'https://buy.stripe.com/fZu7sEaPYdmvcnl8mA48005', // 50 scans for $2.99
                    'value': 'https://buy.stripe.com/aFadR2bU2cirevt6es48006',    // 200 scans for $9.99
                    'power': 'https://buy.stripe.com/bJe7sE9LU1DN2MLeKY48007'     // 500 scans for $19.99
                };
                
                console.log(`🚀 Redirecting to Stripe checkout: ${scanPackageUrls[packageType]}`);
                
                // Redirect to Stripe payment page
                setTimeout(() => {
                    window.location.href = scanPackageUrls[packageType];
                }, 500);
                
            } catch (error) {
                console.error('Purchase error:', error);
                alert('Something went wrong. Please try again.');
                document.getElementById('scanPackageLoading').style.display = 'none';
            }
        }

        // Handle scan package purchase success
        function handleScanPurchaseSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.get('scan_purchase') === 'success') {
                const packageType = urlParams.get('package');
                const scanCount = parseInt(urlParams.get('count') || '0');
                
                if (scanCount > 0) {
                    addPurchasedScans(scanCount);
                    
                    setTimeout(() => {
                        alert(`🎉 Purchase Successful!\n\n${scanCount} scans have been added to your account.\n\nYou can use them anytime - they never expire!`);
                        
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }, 1000);
                }
            }
        }

        // CAMERA SETUP
        async function initCamera() {
            try {
                console.log("📷 Setting up camera...");
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 }, 
                        height: { ideal: 720 },
                        facingMode: 'environment' 
                    }
                });
                
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    document.getElementById('cameraStatus').style.display = 'none';
                    document.getElementById('scanBtn').disabled = false;
                    console.log("✅ Camera ready");
                };
                
            } catch (error) {
                console.error("❌ Camera error:", error);
                document.getElementById('cameraStatus').innerHTML = "❌ Camera error<br><small>Please allow camera access</small>";
            }
        }

        // SCANNING FUNCTION
        async function scanCard() {
            if (!trackScan()) return;
            
            const btn = document.getElementById('scanBtn');
            btn.disabled = true;
            btn.textContent = "🧠 AI Scanning...";
            
            const video = document.getElementById('video');
            video.style.animation = 'scanPulse 0.5s ease';
            
            try {
                const result = await aiService.scanCard(video);
                
                if (result.hasCard) {
                    displayResult(result);
                    console.log("✅ Scanned:", result.name, "(" + result.confidence + "%) [" + result.source + "]");
                    
                    showScanFeedback('✅ Card Detected!');
                    
                    if (navigator.vibrate) {
                        navigator.vibrate(100);
                    }
                    
                    playCardScanSound();
                    
                    if (result.cardData) {
                        console.log("💰 Real price:", result.cardData.price ? result.cardData.price : 'No price data');
                    }
                } else {
                    document.getElementById('results').innerHTML = 
                        '<div class="placeholder">❌ No MTG card detected<br><small>Try different angle</small></div>';
                }
                
            } catch (error) {
                console.error("❌ Scan error:", error);
                document.getElementById('results').innerHTML = 
                    '<div class="placeholder" style="color: #ff6b6b;">⚠️ Scanning error</div>';
            }
            
            btn.disabled = false;
            btn.textContent = "🧠 AI Scan Card";
            video.style.animation = '';
        }
        
        function showScanFeedback(message) {
            const feedback = document.createElement('div');
            feedback.className = 'scan-feedback';
            feedback.textContent = message;
            document.body.appendChild(feedback);
            
            setTimeout(() => {
                feedback.remove();
            }, 1500);
        }
        
        function playCardScanSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            gainNode.gain.value = 0.1;
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Enhanced display function with edition information
        function displayResult(card) {
            currentCard = card;
            
            const cardData = card.cardData;
            let priceDisplay = '';
            let editionDisplay = '';
            
            if (cardData) {
                // Price display
                if (cardData.price && cardData.price !== 'Price unavailable') {
                    priceDisplay = `<div style="color: #4a90e2; font-weight: bold; margin: 10px 0; font-size: 24px;">💰 ${cardData.price}</div>`;
                } else if (cardData.scryfallError) {
                    priceDisplay = '<div style="color: #ffc107; font-size: 12px; margin: 10px 0;">⚠️ Price temporarily unavailable</div>';
                } else {
                    priceDisplay = '<div style="color: #888; font-size: 12px; margin: 10px 0;">Price loading...</div>';
                }
                
                // Edition/Set display with confidence indicator
                if (cardData.set) {
                    const setCode = cardData.setCode || card.setInfo?.code || '';
                    const editionConfidence = cardData.editionInfo?.matchConfidence || 'Unknown';
                    const confidenceColor = editionConfidence === 'High' ? '#28a745' : '#ffc107';
                    
                    editionDisplay = `
                        <div style="background: rgba(74, 144, 226, 0.1); border: 1px solid rgba(74, 144, 226, 0.3); 
                                    border-radius: 8px; padding: 10px; margin: 10px 0;">
                            <div style="font-weight: bold; color: #4a90e2; margin-bottom: 5px;">📦 Edition Details</div>
                            <div style="font-size: 14px;">
                                <div>Set: <strong>${cardData.set}</strong> (${setCode})</div>
                                ${cardData.collectorNumber ? `<div>Collector #: <strong>${cardData.collectorNumber}</strong></div>` : ''}
                                ${cardData.rarity ? `<div>Rarity: <strong style="color: ${getRarityColor(cardData.rarity)}">${cardData.rarity.charAt(0).toUpperCase() + cardData.rarity.slice(1)}</strong></div>` : ''}
                                ${card.setInfo?.symbol ? `<div>AI Detected: ${card.setInfo.symbol}</div>` : ''}
                                <div style="margin-top: 5px; font-size: 12px; color: ${confidenceColor};">
                                    Detection Confidence: ${editionConfidence}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (card.setInfo) {
                    // Show AI detection results even if Scryfall lookup failed
                    editionDisplay = `
                        <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); 
                                    border-radius: 8px; padding: 10px; margin: 10px 0;">
                            <div style="font-weight: bold; color: #ffc107; margin-bottom: 5px;">📦 AI Edition Detection</div>
                            <div style="font-size: 14px;">
                                ${card.setInfo.inferredSet ? `<div>Likely Set: <strong>${card.setInfo.inferredSet}</strong></div>` : ''}
                                ${card.setInfo.code ? `<div>Set Code: <strong>${card.setInfo.code}</strong></div>` : ''}
                                ${card.setInfo.symbol ? `<div>Symbol: ${card.setInfo.symbol}</div>` : ''}
                                ${card.setInfo.borderColor ? `<div>Border: ${card.setInfo.borderColor}</div>` : ''}
                                ${card.setInfo.year ? `<div>Copyright: ${card.setInfo.year}</div>` : ''}
                                ${card.setInfo.specialFeatures ? `<div>Features: ${card.setInfo.specialFeatures}</div>` : ''}
                                <div style="margin-top: 5px; font-size: 12px; color: #ffc107;">
                                    ⚠️ Edition needs verification
                                </div>
                            </div>
                        </div>
                    `;
                }
            } else {
                priceDisplay = '<div style="color: #888; font-size: 12px; margin: 10px 0;">Fetching card data...</div>';
            }
            
            const sourceInfo = card.isFallback ? 
                '<div style="color: #ffc107; font-size: 11px;">⚠️ Using backup detection</div>' : 
                `<div style="color: #28a745; font-size: 11px;">✅ AI Detection (${card.source})</div>`;
            
            document.getElementById('results').innerHTML = 
                '<div class="result-card">' +
                '<h4>' + card.name + '</h4>' +
                '<div class="confidence">Recognition Confidence: ' + card.confidence + '%</div>' +
                sourceInfo +
                editionDisplay +
                priceDisplay +
                '<div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">' +
                '<button onclick="saveToCollection()" class="btn" style="background: #28a745; color: white;">💾 Save to Collection</button>' +
                (cardData && cardData.scryfallUri ? 
                    `<button onclick="window.open('${cardData.scryfallUri}', '_blank')" class="btn" style="background: #4a90e2; color: white;">🔗 View on Scryfall</button>` : '') +
                (cardData && cardData.image ? 
                    `<button onclick="showCardImage('${cardData.image}')" class="btn" style="background: #6f42c1; color: white;">🖼️ View Full Image</button>` : '') +
                '</div>' +
                '</div>';
        }

        // Helper function to get rarity color
        function getRarityColor(rarity) {
            const colors = {
                'common': '#000',
                'uncommon': '#708090',
                'rare': '#FFD700',
                'mythic': '#FF6B35'
            };
            return colors[rarity] || '#888';
        }

        // Function to show card image in modal
        function showCardImage(imageUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.9); display: flex; align-items: center;
                justify-content: center; z-index: 10000; padding: 20px;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = 'max-width: 100%; max-height: 100%; border-radius: 15px;';
            
            modal.onclick = () => modal.remove();
            modal.appendChild(img);
            document.body.appendChild(modal);
        }

        function saveToCollection() {
            if (!currentCard) return;
            
            const cardWithId = {
                name: currentCard.name,
                confidence: currentCard.confidence,
                source: currentCard.source,
                cardData: currentCard.cardData,
                setInfo: currentCard.setInfo, // Include AI-detected set info
                id: Date.now(),
                savedAt: new Date().toISOString()
            };
            
            collections[activeBinder].unshift(cardWithId);
            localStorage.setItem('mtg_collections', JSON.stringify(collections));
            
            console.log("✅ Card saved with edition info:", cardWithId);
            updateBinderDisplay();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = "✅ Saved!";
            btn.style.background = "#218838";
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = "#28a745";
            }, 2000);
            
            // Show toast with edition info
            const edition = cardWithId.cardData?.set || cardWithId.setInfo?.inferredSet || 'Unknown Edition';
            showProfessionalToast(`✅ ${cardWithId.name} (${edition}) saved to ${activeBinder}!`, 'success', 3000);
        }

        // COLLECTION MANAGEMENT
        function switchBinder(binderName) {
            activeBinder = binderName;
            
            document.querySelectorAll('.binder-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[data-binder="${binderName}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            updateBinderDisplay();
            console.log(`📚 Switched to binder: ${binderName}`);
        }

        // AI SORTING FUNCTIONS
        function aiSortCollection() {
            const currentBinder = collections[activeBinder];
            if (currentBinder.length < 2) {
                alert('Need at least 2 cards to sort!');
                return;
            }

            const sortOptions = [
                'Color Identity (WUBRG)',
                'Card Type (Creature, Instant, etc)',
                'Mana Value (CMC)',
                'Rarity (Mythic → Common)',
                'Price (High → Low)',
                'Alphabetical',
                'Set Release Date',
                'Format Legality'
            ];

            const choice = prompt(`🤖 AI Sort Options:\n\n${sortOptions.map((opt, i) => `${i+1}. ${opt}`).join('\n')}\n\nEnter number (1-${sortOptions.length}):`);
            
            if (!choice) return;

            switch(parseInt(choice)) {
                case 1: // Color
                    aiSortByColor();
                    break;
                case 2: // Type
                    aiSortByType();
                    break;
                case 3: // CMC
                    aiSortByCMC();
                    break;
                case 4: // Rarity
                    aiSortByRarity();
                    break;
                case 5: // Price
                    aiSortByPrice();
                    break;
                case 6: // Alphabetical
                    collections[activeBinder].sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 7: // Set Date
                    aiSortBySetDate();
                    break;
                case 8: // Format
                    aiGroupByFormat();
                    break;
            }

            updateBinderDisplay();
            localStorage.setItem('mtg_collections', JSON.stringify(collections));
            showProfessionalToast('✅ Collection sorted!', 'success');
        }

        function aiSortByColor() {
            const colorOrder = { 'W': 1, 'U': 2, 'B': 3, 'R': 4, 'G': 5 };
            collections[activeBinder].sort((a, b) => {
                const aColors = a.cardData?.colors || [];
                const bColors = b.cardData?.colors || [];
                
                if (aColors.length === 0) return 1;
                if (bColors.length === 0) return -1;
                
                const aValue = Math.min(...aColors.map(c => colorOrder[c] || 6));
                const bValue = Math.min(...bColors.map(c => colorOrder[c] || 6));
                
                return aValue - bValue;
            });
        }

        function aiSortByType() {
            const typeOrder = {
                'Land': 1,
                'Creature': 2,
                'Planeswalker': 3,
                'Artifact': 4,
                'Enchantment': 5,
                'Instant': 6,
                'Sorcery': 7
            };
            
            collections[activeBinder].sort((a, b) => {
                const aType = a.cardData?.type_line || a.cardData?.cardType || a.cardType || '';
                const bType = b.cardData?.type_line || b.cardData?.cardType || b.cardType || '';
                
                let aOrder = 8;
                let bOrder = 8;
                
                for (const [type, order] of Object.entries(typeOrder)) {
                    if (aType.includes(type)) aOrder = Math.min(aOrder, order);
                    if (bType.includes(type)) bOrder = Math.min(bOrder, order);
                }
                
                return aOrder - bOrder;
            });
        }

        function aiSortByCMC() {
            collections[activeBinder].sort((a, b) => {
                const aCMC = a.cardData?.cmc || 0;
                const bCMC = b.cardData?.cmc || 0;
                return aCMC - bCMC;
            });
        }

        function aiSortByRarity() {
            const rarityOrder = { 'mythic': 1, 'rare': 2, 'uncommon': 3, 'common': 4 };
            collections[activeBinder].sort((a, b) => {
                const aRarity = a.cardData?.rarity || 'common';
                const bRarity = b.cardData?.rarity || 'common';
                return (rarityOrder[aRarity] || 5) - (rarityOrder[bRarity] || 5);
            });
        }

        function aiSortByPrice() {
            collections[activeBinder].sort((a, b) => {
                const aPrice = parseFloat(a.cardData?.price?.replace('$', '') || '0');
                const bPrice = parseFloat(b.cardData?.price?.replace('$', '') || '0');
                return bPrice - aPrice; // High to low
            });
        }

        function aiSortBySetDate() {
            collections[activeBinder].sort((a, b) => {
                const aDate = a.cardData?.releaseDate || '1993-01-01';
                const bDate = b.cardData?.releaseDate || '1993-01-01';
                return new Date(bDate) - new Date(aDate); // Newest first
            });
        }

        function aiGroupByFormat() {
            const groups = {
                standard: [],
                modern: [],
                legacy: [],
                vintage: [],
                commander: []
            };
            
            collections[activeBinder].forEach(card => {
                groups.commander.push(card); // All cards legal in Commander
            });
            
            alert('🤖 AI Format Grouping:\n\n' + 
                  Object.entries(groups).map(([format, cards]) => 
                      `${format.toUpperCase()}: ${cards.length} cards`
                  ).join('\n'));
        }

        // EXPORT FUNCTIONS
        function exportCollection() {
            const formats = [
                'Moxfield',
                'Archidekt', 
                'TXT (Simple)',
                'CSV (Excel)',
                'JSON (Backup)',
                'MTGO Format',
                'TCGPlayer Mass Entry'
            ];

            const choice = prompt(`📤 Export Format:\n\n${formats.map((f, i) => `${i+1}. ${f}`).join('\n')}\n\nEnter number (1-${formats.length}):`);
            
            if (!choice) return;

            const binder = collections[activeBinder];
            let exportData = '';
            let filename = `mtg-${activeBinder}-${new Date().toISOString().split('T')[0]}`;

            switch(parseInt(choice)) {
                case 1: // Moxfield
                    exportData = binder.map(card => `1 ${card.name}`).join('\n');
                    filename += '.txt';
                    break;
                    
                case 2: // Archidekt
                    exportData = binder.map(card => {
                        const set = card.cardData?.setCode || '';
                        const num = card.cardData?.collectorNumber || '';
                        return `1 ${card.name} [${set}] ${num}`;
                    }).join('\n');
                    filename += '_archidekt.txt';
                    break;
                    
                case 3: // Simple TXT
                    exportData = binder.map(card => card.name).join('\n');
                    filename += '_simple.txt';
                    break;
                    
                case 4: // CSV
                    exportData = 'Name,Set,Rarity,Price,Date Added\n';
                    exportData += binder.map(card => 
                        `"${card.name}","${card.cardData?.set || ''}","${card.cardData?.rarity || ''}","${card.cardData?.price || '0'}","${card.savedAt}"`
                    ).join('\n');
                    filename += '.csv';
                    break;
                    
                case 5: // JSON
                    exportData = JSON.stringify({
                        binder: activeBinder,
                        cards: binder,
                        exportDate: new Date().toISOString(),
                        totalValue: calculateBinderValue()
                    }, null, 2);
                    filename += '.json';
                    break;
                    
                case 6: // MTGO
                    exportData = binder.map(card => `1 ${card.name}`).join('\n');
                    filename += '_mtgo.txt';
                    break;
                    
                case 7: // TCGPlayer
                    exportData = binder.map(card => 
                        `1x ${card.name} [${card.cardData?.set || 'Unknown'}]`
                    ).join('\n');
                    filename += '_tcgplayer.txt';
                    break;
            }

            // Download file
            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showProfessionalToast(`📤 Exported ${binder.length} cards!`, 'success');
        }

        function calculateBinderValue() {
            return collections[activeBinder].reduce((total, card) => {
                const price = parseFloat(card.cardData?.price?.replace('$', '') || '0');
                return total + price;
            }, 0).toFixed(2);
        }

        function showProfessionalToast(message, type = 'info', duration = 3000) {
            const existingToasts = document.querySelectorAll('.toast-message');
            existingToasts.forEach(toast => toast.remove());

            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                z-index: 10001;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                max-width: 300px;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, duration);
        }

        function updateBinderDisplay() {
            const binder = collections[activeBinder] || [];
            const container = document.getElementById('binderCards');
            
            if (binder.length === 0) {
                container.innerHTML = 
                    '<div style="text-align: center; color: #888; padding: 40px;">' +
                    `No cards in ${activeBinder} collection yet. Start scanning to build your collection!` +
                    '</div>';
            } else {
                container.innerHTML = binder.map(card => 
                    `<div class="collection-card">
                        <div class="card-name">${card.name}</div>
                        <div class="card-details">
                            <div>Confidence: ${card.confidence}%</div>
                            <div>Added: ${new Date(card.savedAt).toLocaleDateString()}</div>
                            ${card.cardData && card.cardData.set ? `<div>Set: ${card.cardData.set}</div>` : ''}
                            ${card.cardData && card.cardData.type_line ? `<div>Type: ${card.cardData.type_line}</div>` : ''}
                        </div>
                        ${card.cardData && card.cardData.price ? 
                            `<div class="card-price">${card.cardData.price}</div>` :
                            '<div style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; display: inline-block;">Price Loading...</div>'
                        }
                        <div style="margin-top: 10px; display: flex; gap: 8px;">
                            <button onclick="removeFromCollection('${card.id}')" class="btn" style="background: #dc3545; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">🗑️</button>
                            <button onclick="moveCard('${card.id}')" class="btn" style="background: #6f42c1; color: white; padding: 4px 8px; font-size: 12px; border-radius: 4px;">📁</button>
                        </div>
                    </div>`
                ).join('');
            }
            
            updateBinderStats();
        }

        function updateBinderStats() {
            const allCards = Object.values(collections).flat();
            const uniqueCards = [...new Set(allCards.map(card => card.name))];
            
            let totalValue = 0;
            let priceCount = 0;
            
            allCards.forEach(card => {
                if (card.cardData && card.cardData.price) {
                    const price = parseFloat(card.cardData.price.replace('$', '') || '0');
                    totalValue += price;
                    priceCount++;
                }
            });
            
            document.getElementById('totalCards').textContent = allCards.length;
            document.getElementById('uniqueCards').textContent = uniqueCards.length;
            document.getElementById('totalValue').textContent = priceCount > 0 ? 
                '$' + totalValue.toFixed(2) : '$0.00';
        }

        // Remove card from collection
        function removeFromCollection(cardId) {
            const index = collections[activeBinder].findIndex(card => card.id == cardId);
            if (index > -1) {
                const card = collections[activeBinder][index];
                if (confirm(`Remove ${card.name} from collection?`)) {
                    collections[activeBinder].splice(index, 1);
                    localStorage.setItem('mtg_collections', JSON.stringify(collections));
                    updateBinderDisplay();
                    showProfessionalToast('Card removed', 'info');
                }
            }
        }

        // Move card to another binder
        function moveCard(cardId) {
            const card = collections[activeBinder].find(c => c.id == cardId);
            if (!card) return;
            
            const binders = Object.keys(collections).filter(b => b !== activeBinder);
            const choice = prompt(`Move ${card.name} to:\n\n${binders.map((b, i) => `${i+1}. ${b}`).join('\n')}`);
            
            if (choice && binders[parseInt(choice) - 1]) {
                const targetBinder = binders[parseInt(choice) - 1];
                collections[targetBinder].unshift(card);
                collections[activeBinder] = collections[activeBinder].filter(c => c.id != cardId);
                localStorage.setItem('mtg_collections', JSON.stringify(collections));
                updateBinderDisplay();
                showProfessionalToast(`Moved to ${targetBinder}`, 'success');
            }
        }

        // AUTO MODE
        function toggleAutoMode() {
            autoMode = !autoMode;
            const btn = document.getElementById('autoBtn');
            
            if (autoMode) {
                btn.textContent = "⏹️ Stop";
                btn.style.background = "#dc3545";
                
                autoInterval = setInterval(() => {
                    if (!document.getElementById('scanBtn').disabled) {
                        scanCard();
                    }
                }, 4000);
                
                console.log("▶️ Auto mode started");
            } else {
                btn.textContent = "▶️ Auto";
                btn.style.background = "#28a745";
                
                if (autoInterval) {
                    clearInterval(autoInterval);
                    autoInterval = null;
                }
                
                console.log("⏹️ Auto mode stopped");
            }
        }

        // Search and filter functions
        function filterCollection() {
            const searchTerm = document.getElementById('collectionSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.collection-card');
            
            cards.forEach(card => {
                const cardName = card.querySelector('.card-name').textContent.toLowerCase();
                const cardDetails = card.querySelector('.card-details').textContent.toLowerCase();
                
                if (cardName.includes(searchTerm) || cardDetails.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        function batchOperations() {
            const operations = [
                'Move all cards to another binder',
                'Delete cards by rarity',
                'Export selected cards',
                'Group by color identity',
                'Find duplicates',
                'Calculate deck statistics'
            ];
            
            const choice = prompt(`⚡ Batch Operations:\n\n${operations.map((op, i) => `${i+1}. ${op}`).join('\n')}\n\nEnter number (1-${operations.length}):`);
            
            if (!choice) return;
            
            switch(parseInt(choice)) {
                case 1:
                    batchMoveBinder();
                    break;
                case 2:
                    batchDeleteByRarity();
                    break;
                case 3:
                    batchExport();
                    break;
                case 4:
                    groupByColorIdentity();
                    break;
                case 5:
                    findDuplicates();
                    break;
                case 6:
                    calculateDeckStats();
                    break;
            }
        }

        function batchMoveBinder() {
            const currentBinder = collections[activeBinder];
            if (currentBinder.length === 0) {
                alert('No cards to move!');
                return;
            }
            
            const binders = Object.keys(collections).filter(b => b !== activeBinder);
            const choice = prompt(`📁 Move ALL ${currentBinder.length} cards to:\n\n${binders.map((b, i) => `${i+1}. ${b}`).join('\n')}\n\nEnter number (1-${binders.length}):`);
            
            if (!choice || !binders[parseInt(choice) - 1]) return;
            
            const targetBinder = binders[parseInt(choice) - 1];
            
            if (confirm(`Move ALL ${currentBinder.length} cards from ${activeBinder} to ${targetBinder}?`)) {
                collections[targetBinder] = [...collections[targetBinder], ...currentBinder];
                collections[activeBinder] = [];
                
                localStorage.setItem('mtg_collections', JSON.stringify(collections));
                updateBinderDisplay();
                
                showProfessionalToast(`📁 Moved ${currentBinder.length} cards to ${targetBinder}`, 'success');
            }
        }

        function findDuplicates() {
            const duplicates = {};
            const currentBinder = collections[activeBinder];
            
            currentBinder.forEach(card => {
                const key = card.name.toLowerCase();
                if (!duplicates[key]) duplicates[key] = [];
                duplicates[key].push(card);
            });
            
            const dupeList = Object.entries(duplicates)
                .filter(([name, cards]) => cards.length > 1)
                .map(([name, cards]) => `${cards[0].name}: ${cards.length} copies`)
                .join('\n');
            
            if (dupeList) {
                alert(`🔍 Duplicates Found:\n\n${dupeList}`);
            } else {
                alert('✅ No duplicates found in this binder!');
            }
        }

        function calculateDeckStats() {
            const currentBinder = collections[activeBinder];
            if (currentBinder.length === 0) {
                alert('No cards to analyze!');
                return;
            }
            
            const stats = {
                totalCards: currentBinder.length,
                totalValue: 0,
                avgCMC: 0,
                colorDistribution: {},
                typeDistribution: {},
                rarityDistribution: {}
            };
            
            let totalCMC = 0;
            let cmcCount = 0;
            
            currentBinder.forEach(card => {
                // Value
                const price = parseFloat(card.cardData?.price?.replace('$', '') || '0');
                stats.totalValue += price;
                
                // CMC
                const cmc = card.cardData?.cmc || 0;
                if (cmc > 0) {
                    totalCMC += cmc;
                    cmcCount++;
                }
                
                // Colors
                const colors = card.cardData?.colors || [];
                colors.forEach(color => {
                    stats.colorDistribution[color] = (stats.colorDistribution[color] || 0) + 1;
                });
                
                // Type
                const type = card.cardData?.type_line || 'Unknown';
                const mainType = type.split('—')[0].trim();
                stats.typeDistribution[mainType] = (stats.typeDistribution[mainType] || 0) + 1;
                
                // Rarity
                const rarity = card.cardData?.rarity || 'unknown';
                stats.rarityDistribution[rarity] = (stats.rarityDistribution[rarity] || 0) + 1;
            });
            
            stats.avgCMC = cmcCount > 0 ? (totalCMC / cmcCount).toFixed(2) : 0;
            
            const report = `📊 DECK STATISTICS - ${activeBinder.toUpperCase()}\n\n` +
                          `Total Cards: ${stats.totalCards}\n` +
                          `Total Value: $${stats.totalValue.toFixed(2)}\n` +
                          `Average CMC: ${stats.avgCMC}\n\n` +
                          `COLOR DISTRIBUTION:\n${Object.entries(stats.colorDistribution).map(([c, n]) => `${c}: ${n}`).join('\n') || 'None'}\n\n` +
                          `TYPE DISTRIBUTION:\n${Object.entries(stats.typeDistribution).map(([t, n]) => `${t}: ${n}`).join('\n')}\n\n` +
                          `RARITY:\n${Object.entries(stats.rarityDistribution).map(([r, n]) => `${r}: ${n}`).join('\n')}`;
            
            alert(report);
        }

        // EVENT LISTENERS & INITIALIZATION
        window.addEventListener('load', async function() {
            console.log("🚀 Initializing Enhanced MTG Scanner with Edition Detection...");
            
            // HANDLE STRIPE PAYMENT SUCCESS
            const urlParams = new URLSearchParams(window.location.search);
            
            console.log('🔍 URL Parameters:', window.location.search);
            console.log('🔍 Payment param:', urlParams.get('payment'));
            console.log('🔍 Plan param:', urlParams.get('plan'));
            
            if (urlParams.get('payment') === 'success' || urlParams.get('success') === 'true') {
                const plan = urlParams.get('plan') || 'premium';
                
                console.log('✅ PAYMENT SUCCESS DETECTED! Plan:', plan);
                
                localStorage.setItem('mtg_user_tier', 'premium');
                localStorage.setItem('mtg_plan_type', plan);
                localStorage.setItem('mtg_premium_date', new Date().toISOString());
                userTier = 'premium';
                userPlan = plan;
                
                console.log('✅ Premium activated - Tier: premium, Plan:', plan);
                
                document.getElementById('userTierDisplay').textContent = 'Premium';
                document.getElementById('usageLimit').textContent = '999';
                
                setTimeout(() => {
                    alert(`🎉 Payment Successful!\n\nWelcome to MTG Scanner Pro ${plan.toUpperCase()}!\n\nYou now have unlimited scans and premium features.`);
                    updateUsageDisplay();
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }, 1000);
                
                setTimeout(() => {
                    window.history.replaceState({}, document.title, window.location.pathname);
                }, 3000);
                
                console.log('✅ Premium activated from Stripe payment!');
            }
            
            if (urlParams.get('session_id')) {
                localStorage.setItem('mtg_user_tier', 'premium');
                userTier = 'premium';
                console.log('✅ Stripe session detected - premium activated!');
                updateUsageDisplay();
            }
            
            // Handle scan package purchase success
            handleScanPurchaseSuccess();
            
            // Load saved collections and user data
            const savedCollections = localStorage.getItem('mtg_collections');
            if (savedCollections) {
                try {
                    const loaded = JSON.parse(savedCollections);
                    collections = {
                        main: loaded.main || [],
                        premium: loaded.premium || [],
                        trade: loaded.trade || [],
                        edh: loaded.edh || [],
                        modern: loaded.modern || [],
                        standard: loaded.standard || [],
                        wishlist: loaded.wishlist || [],
                        custom1: loaded.custom1 || [],
                        custom2: loaded.custom2 || []
                    };
                } catch (e) {
                    console.log("❌ Error loading collections:", e);
                }
            }
            
            // Load user plan and fix any mismatches
            userPlan = localStorage.getItem('mtg_plan_type') || userTier;
            
            if (userPlan !== 'free' && userPlan !== userTier && userTier === 'free') {
                console.log('🔧 Fixing tier/plan mismatch - upgrading to premium');
                localStorage.setItem('mtg_user_tier', 'premium');
                userTier = 'premium';
                window.mtgMismatchFixed = true;
            }
            
            const premiumDate = localStorage.getItem('mtg_premium_date');
            if (premiumDate && userTier === 'free') {
                console.log('🔧 Found premium date but free tier - investigating...');
                if (userPlan && userPlan !== 'free') {
                    localStorage.setItem('mtg_user_tier', 'premium');
                    userTier = 'premium';
                    window.mtgMismatchFixed = true;
                    console.log('✅ Auto-upgraded to premium based on payment history');
                }
            }
            
            // Set up event listeners
            document.getElementById('scanBtn').addEventListener('click', scanCard);
            document.getElementById('autoBtn').addEventListener('click', toggleAutoMode);
            
            // Binder tabs
            document.querySelectorAll('.binder-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchBinder(this.dataset.binder);
                });
            });
            
            // Start loading sequence
            runLoadingSequence();
            
            // Initialize displays
            updateUsageDisplay();
            updateBinderDisplay();
            
            // Set up upgrade button
            const upgradeBtn = document.getElementById('upgradeBtn');
            if (userTier !== 'premium') {
                upgradeBtn.addEventListener('click', openUpgradeModal);
            }
            
            if (window.mtgMismatchFixed) {
                setTimeout(() => {
                    alert(`✅ Premium Status Fixed!\n\nYour ${userPlan} plan is now properly activated.\n\nEnjoy unlimited scanning!`);
                }, 1500);
            }
            
            await initCamera();
            
            console.log("✅ Enhanced MTG Scanner ready (PRODUCTION VERSION v1.3 with Edition Detection)!");
            console.log("🔧 Features:");
            console.log("  - ✅ Edition Detection: AI identifies sets by symbols and features");
            console.log("  - ✅ Scryfall API: Fixed parsing and set-specific lookups");
            console.log("  - ✅ AI Recognition: 95% accuracy with Gemini");
            console.log("  - ✅ Collections: 7+ custom binders");
            console.log("  - ✅ Export: Moxfield, Archidekt, CSV, JSON, MTGO, TCGPlayer");
            console.log("  - ✅ AI Sorting: By color, type, CMC, rarity, price");
            console.log("  - ✅ Batch Operations: Move, delete, filter, stats");
            console.log("  - ✅ Search & Filter: Real-time collection search");
            console.log("  - ✅ Scan Packages: Buy extra scans when needed");
            console.log("📊 User Status:");
            console.log("  - Tier:", userTier);
            console.log("  - Plan:", userPlan);
            console.log("  - Usage:", userTier === 'premium' ? `${getMonthlyUsage()} (monthly)` : `${getTodayUsage()} (daily)`);
            console.log("  - Purchased Scans:", getPurchasedScans());
            
            // Add helper function for plan management (for debugging)
            window.mtgDebug = {
                getPlan: () => ({ tier: userTier, plan: userPlan }),
                setPlan: (plan) => {
                    localStorage.setItem('mtg_plan_type', plan);
                    userPlan = plan;
                    updateUsageDisplay();
                    console.log('✅ Plan updated to:', plan);
                },
                resetToFree: () => {
                    localStorage.removeItem('mtg_user_tier');
                    localStorage.removeItem('mtg_plan_type');
                    localStorage.removeItem('mtg_premium_date');
                    location.reload();
                },
                showStorage: () => {
                    console.log('📦 LocalStorage MTG data:');
                    Object.keys(localStorage).filter(k => k.includes('mtg')).forEach(key => {
                        console.log(`  ${key}:`, localStorage.getItem(key));
                    });
                    console.log('📊 Usage Stats:');
                    console.log(`  Daily: ${getTodayUsage()}`);
                    console.log(`  Monthly: ${getMonthlyUsage()}`);
                    console.log(`  Purchased: ${getPurchasedScans()}`);
                },
                exportData: () => {
                    const data = {
                        user: { tier: userTier, plan: userPlan, date: localStorage.getItem('mtg_premium_date') },
                        collections: collections,
                        usage: {
                            daily: getTodayUsage(),
                            monthly: getMonthlyUsage(),
                            purchased: getPurchasedScans(),
                            date: new Date().toISOString()
                        },
                        exportDate: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `mtg-scanner-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    console.log('✅ Data exported!');
                }
            };
        });

        // Make additional functions available globally
        window.filterCollection = filterCollection;
        window.batchOperations = batchOperations;
        window.saveToCollection = saveToCollection;
        window.exportCollection = exportCollection;
        window.aiSortCollection = aiSortCollection;
        window.showProfessionalToast = showProfessionalToast;
        window.removeFromCollection = removeFromCollection;
        window.moveCard = moveCard;
        window.showCardImage = showCardImage;
        
        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (autoInterval) clearInterval(autoInterval);
            const video = document.getElementById('video');
            if (video && video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>